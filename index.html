<!DOCTYPE html>
<!-- BTC Monitor â€” Built 2026-02-27 09:53:22 -->
<!-- Source: 14 JS modules + 1 CSS -->

<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BTC Monitor v3</title>
<style>
/* ============================================================
   STYLES.CSS â€” BTC Monitor
   ============================================================ */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&family=IBM+Plex+Mono:wght@400;600;700&family=Bebas+Neue&display=swap');

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg:     #080a0e;
  --card:   #0f1219;
  --card2:  #161b24;
  --border: #1c2233;
  --text:   #dfe2ea;
  --dim:    #5c6378;
  --amber:  #efb420;
  --amber-d:rgba(239,180,32,.12);
  --red:    #e74c5a;
  --red-d:  rgba(231,76,90,.10);
  --green:  #2db87e;
  --green-d:rgba(45,184,126,.10);
  --blue:   #3a8ee6;
  --mono:   'IBM Plex Mono', monospace;
}

body { font-family:'Noto Sans KR',sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; }

/* â”€â”€ TOP BAR â”€â”€ */
.top { position:sticky; top:0; z-index:100; background:rgba(8,10,14,.92); backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border); padding:10px 16px; display:flex; align-items:center; justify-content:space-between; }
.top-left  { display:flex; align-items:center; gap:8px; }
.logo      { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:2px; color:var(--amber); }
.badge     { font-family:var(--mono); font-size:10px; font-weight:700; padding:2px 7px; border-radius:3px; }
.badge-live{ background:var(--red-d); color:var(--red); display:flex; align-items:center; gap:4px; }
.dot       { width:5px; height:5px; background:var(--red); border-radius:50%; animation:blink 1.4s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
.top-right { display:flex; align-items:center; gap:10px; }
.clock     { font-family:var(--mono); font-size:12px; color:var(--dim); }
.live-price{ font-family:var(--mono); font-size:17px; font-weight:700; color:var(--amber); }

/* ì„¤ì • ë²„íŠ¼ */
.icon-btn { background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:7px;
  width:32px; height:32px; display:flex; align-items:center; justify-content:center;
  font-size:15px; cursor:pointer; transition:.15s; color:var(--dim); }
.icon-btn:hover { background:var(--amber-d); color:var(--amber); border-color:var(--amber); }

/* â”€â”€ WRAPPER â”€â”€ */
.wrap { max-width:960px; margin:0 auto; padding:0 12px 90px; }

/* â”€â”€ TABS â”€â”€ */
.tabs { display:flex; gap:3px; margin:10px 0; background:var(--card); border-radius:10px; padding:3px; border:1px solid var(--border); }
.tab  { flex:1; padding:9px 0; border:none; border-radius:8px; background:transparent; color:var(--dim);
  font-family:inherit; font-size:12px; font-weight:800; cursor:pointer; transition:.15s; }
.tab.on { background:var(--amber); color:#080a0e; }
.tab:not(.on):hover { color:var(--text); }
.pane { display:none; } .pane.on { display:block; }

/* â”€â”€ CARDS â”€â”€ */
.c       { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:8px; }
.c-title { font-size:10px; font-weight:800; color:var(--dim); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:10px; }

/* â”€â”€ S/R ZONES â”€â”€ */
.zone { border-radius:10px; padding:12px 14px; margin-bottom:6px; border-left:3px solid; }
.zone:last-child { margin-bottom:0; }
.zone.r  { background:var(--red-d);   border-color:var(--red);   }
.zone.s  { background:var(--green-d); border-color:var(--green); }
.zone .zl{ font-size:11px; font-weight:700; margin-bottom:3px; }
.zone.r .zl { color:#f88; }
.zone.s .zl { color:#7edaa8; }
.zv { font-family:var(--mono); font-size:19px; font-weight:700; display:flex; align-items:center; gap:8px; }
.zone.r .zv { color:var(--red);   }
.zone.s .zv { color:var(--green); }
.sep { font-size:13px; color:var(--dim); }

/* Pivot badge */
.pivot-row { display:flex; align-items:center; justify-content:center; gap:8px;
  margin:8px 0; padding:8px; background:var(--amber-d); border-radius:8px; border:1px solid rgba(239,180,32,.2); }
.pivot-label { font-size:10px; font-weight:800; color:var(--amber); letter-spacing:1px; }
.pivot-val   { font-family:var(--mono); font-size:16px; font-weight:700; color:var(--amber); }

/* â”€â”€ META â”€â”€ */
.mg { display:grid; grid-template-columns:repeat(3,1fr); gap:5px; margin-top:6px; }
.mc { background:rgba(255,255,255,.02); border-radius:7px; padding:7px; text-align:center; }
.mc .k { font-size:9px; color:var(--dim); }
.mc .v { font-family:var(--mono); font-size:12px; font-weight:700; margin-top:1px; }

/* â”€â”€ CHART â”€â”€ */
.chart-wrap { position:relative; background:var(--card); border:1px solid var(--border);
  border-radius:12px; overflow:hidden; margin-bottom:8px; }
#chart { width:100%; height:420px; }
.tf-bar { position:absolute; top:8px; left:8px; z-index:10; display:flex; gap:3px; }
.tf     { background:rgba(22,27,36,.85); color:var(--dim); border:1px solid var(--border);
  padding:4px 10px; border-radius:5px; font-family:var(--mono); font-size:11px; font-weight:700; cursor:pointer; transition:.15s; }
.tf.on  { background:var(--amber); color:#080a0e; border-color:var(--amber); }
.chart-legend { position:absolute; top:8px; right:8px; z-index:10; display:flex; gap:8px; }
.leg { font-family:var(--mono); font-size:10px; display:flex; align-items:center; gap:4px; color:var(--dim); }
.leg-dot { width:8px; height:3px; border-radius:1px; }

/* Binance chart btn */
.ext-btn { display:flex; align-items:center; gap:6px; padding:8px 14px; background:rgba(239,180,32,.08);
  border:1px solid rgba(239,180,32,.3); border-radius:8px; color:var(--amber); font-size:12px;
  font-weight:700; cursor:pointer; transition:.15s; font-family:inherit; }
.ext-btn:hover { background:var(--amber-d); }

/* â”€â”€ HISTORY â”€â”€ */
.fbar { display:flex; gap:3px; margin-bottom:10px; }
.fb   { padding:5px 13px; border:1px solid var(--border); border-radius:5px; background:transparent;
  color:var(--dim); font-family:inherit; font-size:11px; font-weight:800; cursor:pointer; transition:.15s; }
.fb.on { background:var(--amber-d); color:var(--amber); border-color:var(--amber); }
.hi    { background:var(--card); border:1px solid var(--border); border-radius:9px; padding:10px 12px; margin-bottom:5px; }
.hi-d  { font-family:var(--mono); font-size:11px; color:var(--amber); font-weight:700; margin-bottom:4px; }
.hi-d span { color:var(--dim); font-weight:400; }
.hl    { display:flex; align-items:center; gap:6px; font-size:12px; margin-bottom:2px; }
.hl:last-child { margin-bottom:0; }
.ht    { font-family:var(--mono); font-size:10px; font-weight:700; padding:1px 5px;
  border-radius:3px; min-width:24px; text-align:center; }
.ht.r  { background:var(--red-d);   color:var(--red);   }
.ht.s  { background:var(--green-d); color:var(--green); }
.hv    { font-family:var(--mono); font-size:12px; }
.scroll { max-height:420px; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
.scroll::-webkit-scrollbar { width:3px; }
.scroll::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

/* â”€â”€ VOLUME â”€â”€ */
.tog-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
.tog-sw  { width:42px; height:22px; background:var(--border); border-radius:11px;
  position:relative; cursor:pointer; transition:.2s; }
.tog-sw.on { background:var(--amber); }
.tog-sw::after { content:''; position:absolute; width:16px; height:16px; background:#fff;
  border-radius:50%; top:3px; left:3px; transition:.2s; }
.tog-sw.on::after { transform:translateX(20px); }
.va { background:var(--card); border:1px solid var(--border); border-radius:9px;
  padding:10px 12px; margin-bottom:5px; display:flex; align-items:center; gap:10px; }
.vb { font-family:var(--mono); font-size:12px; font-weight:700; padding:3px 8px; border-radius:5px; white-space:nowrap; }
.vb.l2 { background:var(--amber-d);             color:var(--amber); }
.vb.l3 { background:rgba(237,137,54,.14);        color:#ed8936; }
.vb.l4 { background:rgba(229,62,62,.14);         color:#fc8181; }
.vb.l5 { background:var(--red-d);               color:var(--red); }
.vi .vt { font-family:var(--mono); font-size:10px; color:var(--dim); }
.vi .vp { font-family:var(--mono); font-size:12px; font-weight:700; margin-top:1px; }

/* â”€â”€ TOAST â”€â”€ */
.toast-box { position:fixed; top:56px; right:12px; z-index:999; display:flex; flex-direction:column; gap:6px; }
.toast { background:#1a1f2e; border:1px solid var(--amber); border-radius:9px; padding:10px 14px;
  box-shadow:0 6px 28px rgba(0,0,0,.6); animation:tin .3s ease-out, tout .4s ease-in 4.6s forwards; max-width:280px; }
@keyframes tin  { from{transform:translateX(80px);opacity:0} to{transform:translateX(0);opacity:1} }
@keyframes tout { to{opacity:0;transform:translateY(-8px)} }
.toast b    { color:var(--amber); font-size:12px; display:block; margin-bottom:2px; }
.toast span { font-family:var(--mono); font-size:11px; color:var(--dim); }

/* â”€â”€ LOADING / ERROR â”€â”€ */
.ld  { text-align:center; padding:40px 0; color:var(--dim); font-size:13px; }
.sp  { display:inline-block; width:20px; height:20px; border:2.5px solid var(--border);
  border-top-color:var(--amber); border-radius:50%; animation:spin .6s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
.err { background:var(--red-d); border:1px solid rgba(231,76,90,.25); border-radius:9px;
  padding:12px; color:#fca5a5; font-size:13px; margin:8px 0; }
.empty { text-align:center; padding:36px 16px; color:var(--dim); font-size:13px; }
.empty .ei { font-size:30px; margin-bottom:8px; opacity:.4; }

/* â”€â”€ SETTINGS MODAL â”€â”€ */
.modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7);
  z-index:200; align-items:center; justify-content:center; }
.modal-backdrop.open { display:flex; }
.modal { background:var(--card); border:1px solid var(--border); border-radius:16px;
  padding:24px; width:min(380px, 90vw); }
.modal h3 { font-size:15px; font-weight:800; margin-bottom:4px; }
.modal .sub { font-size:11px; color:var(--dim); margin-bottom:18px; }
.field label { display:block; font-size:11px; color:var(--dim); font-weight:700;
  text-transform:uppercase; letter-spacing:1px; margin-bottom:5px; }
.field input { width:100%; background:#0a0d13; border:1px solid var(--border); border-radius:8px;
  padding:9px 12px; color:var(--text); font-family:var(--mono); font-size:12px; outline:none; transition:.15s; }
.field input:focus { border-color:var(--amber); }
.modal-note { margin-top:8px; font-size:10px; color:var(--dim); line-height:1.5; }
.modal-btns { display:flex; gap:8px; margin-top:18px; justify-content:flex-end; }
.btn-ghost   { background:transparent; border:1px solid var(--border); border-radius:8px;
  padding:8px 16px; color:var(--dim); font-family:inherit; font-size:12px; font-weight:700; cursor:pointer; }
.btn-primary { background:var(--amber); border:none; border-radius:8px;
  padding:8px 16px; color:#080a0e; font-family:inherit; font-size:12px; font-weight:800; cursor:pointer; }
.btn-primary:hover { filter:brightness(1.1); }

/* â”€â”€ CRASH DETECTION â”€â”€ */
.crash-control { margin-bottom:14px; }
.crash-ctrl-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.crash-ctrl-label { font-size:11px; font-weight:800; color:var(--dim); text-transform:uppercase; letter-spacing:1px; }
.crash-thresh-display { font-family:var(--mono); font-size:14px; font-weight:700; color:var(--amber); }

.crash-slider {
  -webkit-appearance:none; appearance:none;
  width:100%; height:5px; border-radius:3px;
  background:linear-gradient(to right, var(--amber) 0%, var(--amber) 25%, var(--border) 25%);
  outline:none; cursor:pointer;
}
.crash-slider::-webkit-slider-thumb {
  -webkit-appearance:none; width:18px; height:18px;
  border-radius:50%; background:var(--amber);
  border:2px solid #080a0e; cursor:pointer;
  box-shadow:0 0 6px rgba(239,180,32,.4);
}
.crash-slider::-moz-range-thumb {
  width:18px; height:18px; border-radius:50%;
  background:var(--amber); border:2px solid #080a0e; cursor:pointer;
}
.crash-slider-ticks { display:flex; justify-content:space-between;
  margin-top:4px; font-family:var(--mono); font-size:9px; color:var(--dim); }

.crash-ctrl-row { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:12px; }
.crash-direct { display:flex; align-items:center; gap:6px; }
.crash-input {
  width:68px; background:#0a0d13; border:1px solid var(--border);
  border-radius:7px; padding:6px 10px; color:var(--text);
  font-family:var(--mono); font-size:13px; font-weight:700;
  outline:none; text-align:center; transition:.15s;
}
.crash-input:focus { border-color:var(--amber); }
.crash-input::-webkit-inner-spin-button { -webkit-appearance:none; }

/* ê²°ê³¼ ì¹´ë“œ */
.crash-card {
  background:var(--card); border:1px solid var(--border);
  border-radius:11px; margin-bottom:8px; overflow:hidden;
}
.crash-header {
  display:flex; align-items:center; gap:10px;
  padding:10px 14px; background:rgba(255,255,255,.02);
  border-bottom:1px solid var(--border);
}
.crash-rank {
  font-family:var(--mono); font-size:11px; font-weight:700;
  color:var(--dim); min-width:28px;
}
.crash-drop {
  font-family:var(--mono); font-size:22px; font-weight:700;
  min-width:80px;
}
.crash-recover { font-family:var(--mono); font-size:11px; margin-left:auto; text-align:right; }

.crash-body { padding:12px 14px; }
.crash-row { display:flex; align-items:center; gap:8px; }
.crash-col { flex:1; }
.crash-label { font-size:10px; color:var(--dim); font-weight:700; margin-bottom:2px; }
.crash-date  { font-family:var(--mono); font-size:11px; color:var(--dim); }
.crash-price { font-family:var(--mono); font-size:15px; font-weight:700; margin-top:2px; }
.crash-arrow {
  font-family:var(--mono); font-size:10px; color:var(--dim);
  text-align:center; white-space:nowrap; padding:0 6px;
}

/* ============================================================
   ADDED â€” L1 Ext / L2, Chart, Crash Vol, Funding, Backtest, History
   ============================================================ */

/* â”€â”€ L1 Ext Zone â”€â”€ */
.zone.r-ext { background:rgba(231,76,90,.06); border-color:rgba(231,76,90,.45); border-radius:10px; padding:12px 14px; margin-bottom:6px; border-left:3px solid; }
.zone.s-ext { background:rgba(45,184,126,.06); border-color:rgba(45,184,126,.45); border-radius:10px; padding:12px 14px; margin-bottom:6px; border-left:3px solid; }
.zone.r-ext .zl { color:rgba(255,136,136,.7); font-size:11px; font-weight:700; margin-bottom:3px; }
.zone.s-ext .zl { color:rgba(126,218,168,.7); font-size:11px; font-weight:700; margin-bottom:3px; }
.zone.r-ext .zv { font-family:var(--mono); font-size:19px; font-weight:700; display:flex; align-items:center; gap:8px; color:rgba(231,76,90,.65); }
.zone.s-ext .zv { font-family:var(--mono); font-size:19px; font-weight:700; display:flex; align-items:center; gap:8px; color:rgba(45,184,126,.65); }

/* â”€â”€ L2 Zone â”€â”€ */
.zone.r-l2 { background:rgba(255,152,0,.08); border-color:#ff9800; border-radius:10px; padding:12px 14px; margin-bottom:6px; border-left:3px solid; }
.zone.s-l2 { background:rgba(0,188,212,.08); border-color:#00bcd4; border-radius:10px; padding:12px 14px; margin-bottom:6px; border-left:3px solid; }
.zone.r-l2 .zl { color:#ffb74d; font-size:11px; font-weight:700; margin-bottom:3px; }
.zone.s-l2 .zl { color:#4dd0e1; font-size:11px; font-weight:700; margin-bottom:3px; }
.zone.r-l2 .zv { font-family:var(--mono); font-size:19px; font-weight:700; display:flex; align-items:center; gap:8px; color:#ff9800; }
.zone.s-l2 .zv { font-family:var(--mono); font-size:19px; font-weight:700; display:flex; align-items:center; gap:8px; color:#00bcd4; }

/* â”€â”€ History Ext/L2 Badges â”€â”€ */
.ht.r.ext { background:rgba(231,76,90,.06); color:rgba(231,76,90,.55); }
.ht.s.ext { background:rgba(45,184,126,.06); color:rgba(45,184,126,.55); }
.ht.r.l2  { background:rgba(255,152,0,.08); color:#ff9800; }
.ht.s.l2  { background:rgba(0,188,212,.08); color:#00bcd4; }

/* â”€â”€ Chart Control Bar â”€â”€ */
.chart-ctrl-bar { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; margin-bottom:8px; }
.chart-ctrl-left  { display:flex; gap:4px; }
.chart-ctrl-right { display:flex; gap:4px; align-items:center; }

.zone-btn { padding:6px 14px; border-radius:7px; border:1px solid var(--border); background:var(--card);
  color:var(--dim); font-family:var(--mono); font-size:11px; font-weight:700; cursor:pointer; transition:.15s; }
.zone-btn:hover { background:var(--card2); color:var(--text); }
.zone-btn.on    { background:var(--amber); color:#080a0e; border-color:var(--amber); }
.zone-btn.l2    { border-color:rgba(255,152,0,.3); }
.zone-btn.l2.on { background:#ff9800; color:#080a0e; border-color:#ff9800; }

.date-input { padding:5px 10px; border-radius:7px; border:1px solid var(--border); background:var(--card);
  color:var(--text); font-family:var(--mono); font-size:11px; }
.date-input::-webkit-calendar-picker-indicator { filter:invert(0.6); }

.ctrl-btn { padding:5px 12px; border-radius:7px; border:1px solid var(--border); background:var(--card);
  color:var(--dim); font-size:11px; font-weight:700; font-family:inherit; cursor:pointer; transition:.15s; white-space:nowrap; }
.ctrl-btn:hover  { background:var(--card2); color:var(--text); }
.ctrl-btn.accent { border-color:var(--amber); color:var(--amber); }
.ctrl-btn.accent:hover { background:var(--amber); color:#080a0e; }

.hist-status { font-family:var(--mono); font-size:11px; color:var(--dim); padding:2px 0 6px; }

/* â”€â”€ Crash Window + Volume Tags â”€â”€ */
.crash-win-bar { display:flex; gap:3px; }
.crash-win-btn { padding:6px 16px; border-radius:7px; border:1px solid var(--border); background:var(--card);
  color:var(--dim); font-family:inherit; font-size:12px; font-weight:800; cursor:pointer; transition:.15s; }
.crash-win-btn:hover { background:var(--card2); color:var(--text); }
.crash-win-btn.on { background:var(--amber-d); color:var(--amber); border-color:var(--amber); }

.crash-vol-tag { font-family:var(--mono); font-size:10px; font-weight:700; padding:2px 7px; border-radius:5px; margin-left:auto; white-space:nowrap; }
.crash-vol-tag.vol-high { background:rgba(239,68,68,.15); color:#ef4444; }
.crash-vol-tag.vol-mid  { background:rgba(245,158,11,.12); color:#f59e0b; }
.crash-vol-tag.vol-low  { background:rgba(107,114,128,.1); color:var(--dim); }

.crash-card.strong-signal { border:1px solid rgba(239,68,68,.35); box-shadow:0 0 12px rgba(239,68,68,.08); }

/* â”€â”€ Funding Tab â”€â”€ */
.fund-calc-row { display:flex; align-items:center; gap:6px; margin-top:8px; }
.fund-pos-input { width:100px; padding:5px 8px; border:1px solid var(--border); border-radius:7px;
  background:var(--card); color:var(--text); font-family:var(--mono); font-size:12px; text-align:right; }

.fund-stats { display:grid; grid-template-columns:repeat(4, 1fr); gap:6px; margin:10px 0; }
.fund-stat { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px 10px; text-align:center; }
.fund-stat-label { font-size:10px; color:var(--dim); font-weight:700; text-transform:uppercase; letter-spacing:.5px; margin-bottom:6px; }
.fund-stat-val   { font-family:var(--mono); font-size:16px; font-weight:800; }
.fund-stat-sub   { font-family:var(--mono); font-size:10px; color:var(--dim); margin-top:3px; }

.fund-day { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px 12px; margin-bottom:5px; }
.fund-day-head { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
.fund-day-date { font-family:var(--mono); font-size:12px; font-weight:700; color:var(--text); }
.fund-day-sum  { font-family:var(--mono); font-size:11px; font-weight:700; margin-left:auto; }
.fund-day-cost { font-family:var(--mono); font-size:10px; }
.fund-day-items { display:flex; flex-wrap:wrap; gap:4px 10px; }
.fund-item { font-family:var(--mono); font-size:11px; }

@media (max-width: 600px) {
  .fund-stats { grid-template-columns: repeat(2, 1fr); }
}

/* â”€â”€ Backtest Table â”€â”€ */
.bt-meta { display:flex; gap:1.5rem; padding:10px 14px; font-family:var(--mono); font-size:11px; color:var(--dim);
  background:var(--card); border:1px solid var(--border); border-radius:10px 10px 0 0; border-bottom:none; }
.bt-table { width:100%; border-collapse:collapse; font-family:var(--mono); font-size:12px;
  background:var(--card); border:1px solid var(--border); border-radius:0 0 10px 10px; overflow:hidden; }
.bt-table th { text-align:left; padding:8px 10px; color:var(--dim); font-size:10px; text-transform:uppercase;
  border-bottom:1px solid var(--border); background:var(--card2); }
.bt-table td { padding:7px 10px; border-bottom:1px solid var(--border); }
.bt-section td { padding:10px; font-weight:800; color:var(--amber); background:rgba(239,180,32,.06); font-size:11px; }
.bt-row.good td { color:var(--green); }
.bt-row.mid  td { color:var(--amber); }
.bt-row.weak td { color:var(--red); }
.bt-rate { font-weight:800; }
.bt-legend { padding:10px 0; font-size:11px; color:var(--dim); }
.bt-good { color:var(--green); }
.bt-mid  { color:var(--amber); }
.bt-weak { color:var(--red); }

/* â”€â”€ Heatmap â”€â”€ */
.hm-scroll { overflow-x:auto; margin:0 -2px; }
.hm-grid { width:100%; border-collapse:collapse; font-family:var(--mono); font-size:11px;
  background:var(--card); border:1px solid var(--border); border-radius:10px; overflow:hidden; }
.hm-grid th { padding:8px 4px; text-align:center; font-size:10px; color:var(--dim);
  font-weight:700; text-transform:uppercase; border-bottom:1px solid var(--border);
  background:var(--card2); white-space:nowrap; position:sticky; top:0; }
.hm-corner { text-align:left!important; padding-left:10px!important; min-width:52px; }
.hm-year { padding:6px 10px; font-weight:800; color:var(--text); white-space:nowrap;
  border-right:1px solid var(--border); background:var(--card2); }
.hm-cell { padding:5px 3px; text-align:center; font-size:10px; font-weight:700;
  border-bottom:1px solid rgba(255,255,255,.03); white-space:nowrap; min-width:56px;
  transition:filter .15s; }
.hm-cell:hover { filter:brightness(1.3); }
.hm-yr { border-left:2px solid var(--border)!important; }
.hm-yr-cell { border-left:2px solid var(--border)!important; font-weight:900; }
.hm-summary td { border-top:2px solid var(--border); }
.hm-summary .hm-year { font-size:10px; color:var(--dim); }

.hm-legend { display:flex; justify-content:center; gap:12px; padding:10px 0; font-size:10px; color:var(--dim); }
.hm-leg-item { display:flex; align-items:center; gap:4px; }
.hm-leg-box { width:16px; height:10px; border-radius:2px; display:inline-block; }

/* â”€â”€ Backtest Period Selector â”€â”€ */
.bt-period-bar { display:flex; gap:3px; }
.bt-period-btn { padding:6px 16px; border-radius:7px; border:1px solid var(--border); background:var(--card);
  color:var(--dim); font-family:inherit; font-size:12px; font-weight:800; cursor:pointer; transition:.15s; }
.bt-period-btn:hover { background:var(--card2); color:var(--text); }
.bt-period-btn.on { background:var(--amber-d); color:var(--amber); border-color:var(--amber); }

/* â”€â”€ Funding Date Row â”€â”€ */
.fund-date-row { display:flex; align-items:center; gap:6px; margin-top:8px; flex-wrap:wrap; }

/* â”€â”€ Funding Cost Box â”€â”€ */
.fund-cost-box { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px 14px; margin:8px 0; }
.fund-cost-title { font-size:11px; font-weight:700; color:var(--text); margin-bottom:8px; }
.fund-cost-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
.fund-cost-grid > div { display:flex; flex-direction:column; align-items:center; gap:2px; }
.fund-cost-label { font-size:10px; color:var(--dim); }
.fund-cost-val { font-family:var(--mono); font-size:13px; font-weight:700; }
.fund-stat.highlight { border-color:var(--amber); background:rgba(239,180,32,.04); }

@media (max-width: 600px) {
  .fund-cost-grid { grid-template-columns: repeat(2, 1fr); }
}

/* â”€â”€ Short Signal Tab â”€â”€ */
.ss-verdict { display:flex; align-items:center; gap:10px; padding:14px 16px; margin:8px 0;
  background:var(--card); border:2px solid var(--border); border-radius:12px; }
.ss-verdict-icon { font-size:22px; }
.ss-verdict-text { font-size:16px; font-weight:900; flex:1; }
.ss-verdict-score { font-family:var(--mono); font-size:12px; font-weight:700; display:flex; gap:6px; }

.ss-signals { display:flex; flex-direction:column; gap:3px; margin-bottom:10px; }
.ss-sig-row { display:flex; align-items:center; gap:8px; padding:7px 12px;
  background:var(--card); border:1px solid var(--border); border-radius:8px; }
.ss-sig-icon { font-size:14px; }
.ss-sig-text { font-family:var(--mono); font-size:12px; font-weight:700; color:var(--text); }
.ss-sig-hint { font-size:10px; color:var(--dim); margin-left:auto; }

.ss-section { background:var(--card); border:1px solid var(--border); border-radius:10px;
  padding:12px 14px; margin-bottom:8px; }
.ss-section-title { font-size:12px; font-weight:800; color:var(--text); margin-bottom:10px; }

/* FNG */
.ss-fng-row { display:flex; gap:16px; align-items:center; }
.ss-fng-gauge { width:140px; flex-shrink:0; }
.fng-gauge { width:100%; height:auto; }
.ss-fng-detail { flex:1; }
.ss-fng-label { font-size:14px; font-weight:800; color:var(--text); margin-bottom:8px; }
.ss-fng-hist { display:flex; gap:6px; flex-wrap:wrap; }
.ss-fng-day { display:flex; flex-direction:column; align-items:center; gap:1px;
  font-family:var(--mono); font-size:12px; }
.ss-fng-dt { font-size:9px; color:var(--dim); }

/* OI */
.ss-oi-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:10px; }
.ss-oi-stat { text-align:center; padding:8px; background:var(--card2); border-radius:8px; }
.ss-oi-label { font-size:10px; color:var(--dim); font-weight:700; margin-bottom:4px; }
.ss-oi-val { font-family:var(--mono); font-size:14px; font-weight:800; }
.ss-oi-chart-wrap { background:var(--card2); border-radius:8px; padding:8px; }
.oi-chart { width:100%; height:55px; }

/* Funding summary in short signal */
.ss-fund-row { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
.ss-fund-stat { text-align:center; padding:8px; background:var(--card2); border-radius:8px; }

/* Checklist */
.ss-checklist { display:flex; flex-direction:column; gap:4px; }
.ss-check-item { font-size:12px; color:var(--dim); padding:6px 8px; border-radius:6px;
  background:var(--card2); transition:.15s; }
.ss-check-item.active { color:var(--text); background:rgba(239,180,32,.08); border:1px solid rgba(239,180,32,.2); }

@media (max-width: 600px) {
  .ss-fng-row { flex-direction:column; }
  .ss-fng-gauge { width:120px; }
}

/* â”€â”€ Signal Cards â”€â”€ */
.sig-status-card { display:flex; align-items:center; gap:10px; padding:12px 14px;
  background:var(--card); border:2px solid var(--border); border-radius:10px; }

.sig-card { background:var(--card); border:1px solid var(--border); border-radius:10px;
  padding:12px; margin-bottom:6px; }
.sig-card.stopped { opacity:.6; }
.sig-card.completed { border-color:var(--green); }
.sig-card-head { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
.sig-cross { font-size:10px; color:var(--dim); background:var(--card2); padding:2px 6px; border-radius:4px; }
.sig-time { font-family:var(--mono); font-size:10px; color:var(--dim); margin-left:auto; }
.sig-badge { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; }
.sig-badge.active { background:rgba(239,180,32,.1); color:var(--amber); }
.sig-badge.stopped { background:rgba(231,76,90,.1); color:var(--red); }
.sig-badge.completed { background:rgba(45,184,126,.1); color:var(--green); }

.sig-card-body { display:flex; flex-direction:column; gap:6px; }
.sig-levels { display:flex; gap:4px; flex-wrap:wrap; }
.sig-level { font-family:var(--mono); font-size:11px; display:flex; gap:4px; padding:4px 8px;
  background:var(--card2); border-radius:5px; }
.sig-level.entry { color:var(--text); font-weight:800; }
.sig-level.sl { color:var(--red); }
.sig-tps { display:flex; gap:3px; flex-wrap:wrap; }
.sig-tp { font-family:var(--mono); font-size:10px; padding:3px 6px; background:var(--card2);
  border-radius:4px; }
.sig-tp.hit { background:rgba(45,184,126,.1); border:1px solid var(--green); }

/* â”€â”€ RSI Grid â”€â”€ */
.rsi-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:4px; margin-bottom:8px; }
.rsi-tf-card { text-align:center; padding:8px 4px; background:var(--card2); border-radius:8px; }
.rsi-tf-label { font-size:10px; color:var(--dim); font-weight:700; margin-bottom:4px; }
.rsi-tf-val { font-family:var(--mono); font-size:16px; font-weight:900; }
.rsi-tf-zone { font-size:9px; margin:2px 0; }
.rsi-tf-divs { margin-top:4px; }
.rsi-div-badge { font-size:10px; font-weight:800; padding:2px 5px; border-radius:4px; display:inline-block; }
.rsi-div-badge.bear { background:rgba(231,76,90,.12); color:var(--red); }
.rsi-div-badge.bull { background:rgba(45,184,126,.12); color:var(--green); }
.rsi-div-badge.neutral { color:var(--dim); }

.rsi-div-list { display:flex; flex-direction:column; gap:3px; }
.rsi-div-row { display:flex; align-items:center; gap:8px; padding:5px 8px;
  background:var(--card2); border-radius:5px; font-family:var(--mono); }

@media (max-width: 600px) {
  .rsi-grid { grid-template-columns: repeat(3, 1fr); }
  .sig-levels { flex-direction:column; }
}

/* â”€â”€ RSI Sub-chart â”€â”€ */
.rsi-sub-header { display:flex; justify-content:space-between; align-items:center;
  padding:4px 8px; background:var(--card2); border-top:1px solid var(--border); }
#rsi-chart { border-bottom:1px solid var(--border); }

/* â”€â”€ RSI Mini SVG â”€â”€ */
.rsi-mini-svg { width:100%; height:36px; margin:4px 0 2px; border-radius:4px;
  background:rgba(15,18,25,.5); border:1px solid var(--border); }

</style>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>

<div class="top">
  <div class="top-left">
    <div class="logo">BTC MONITOR</div>
    <div class="badge badge-live"><div class="dot"></div>LIVE</div>
  </div>
  <div class="top-right">
    <div class="clock" id="clk">-</div>
    <div class="live-price" id="lprice">$â€”</div>
    <button class="icon-btn" onclick="App.openSettings()" title="ì„¤ì •">âš™ï¸</button>
  </div>
</div>

<div class="toast-box" id="toasts"></div>

<div class="modal-backdrop" id="settingsModal" onclick="if(event.target===this)App.closeSettings()">
  <div class="modal">
    <h3>âš™ï¸ ì„¤ì •</h3>
    <div class="sub">ë¶„ì„ ë°ì´í„° ì „ìš© Â· ìì‚° ì—°ë™ ì—†ìŒ</div>
    <div class="field">
      <label>Binance API Key (ì„ íƒ)</label>
      <input type="password" id="apiKeyInput" placeholder="Rate limit ì™„í™”ìš© (ì„ íƒì‚¬í•­)">
      <div class="modal-note">â€» ê³µê°œ ì‹œì„¸ ë°ì´í„°ëŠ” API Key ì—†ì´ ì‘ë™í•©ë‹ˆë‹¤.</div>
    </div>
    <div class="modal-btns">
      <button class="btn-ghost" onclick="App.closeSettings()">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="App.saveSettings()">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="tabs">
    <button class="tab on"  onclick="App.go(0)">ì˜¤ëŠ˜</button>
    <button class="tab"     onclick="App.go(1)">ì°¨íŠ¸</button>
    <button class="tab"     onclick="App.go(2)">íˆìŠ¤í† ë¦¬</button>
    <button class="tab"     onclick="App.go(3)">ê±°ë˜ëŸ‰</button>
    <button class="tab"     onclick="App.go(4)">ê¸‰ë½íƒì§€</button>
    <button class="tab"     onclick="App.go(5)">í€ë”©ë¹„</button>
    <button class="tab"     onclick="App.go(6)">ë§¤ë§¤ì‹ í˜¸</button>
    <button class="tab"     onclick="App.go(7)">ìˆ ì‹œê·¸ë„</button>
    <button class="tab"     onclick="App.go(8)">ë°±í…ŒìŠ¤íŠ¸</button>
    <button class="tab"     onclick="App.go(9)">íˆíŠ¸ë§µ</button>
  </div>

  <!-- â•â•â• TAB 0: ì˜¤ëŠ˜ â•â•â• -->
  <div class="pane on" id="p0">
    <div id="loadToday" class="ld"><div class="sp"></div><div style="margin-top:6px">ë¡œë”© ì¤‘...</div></div>
    <div id="today" style="display:none">
      <div class="c">
        <div class="c-title">ğŸ“… L1 â€” ê¸°ë³¸ ì§€ì§€ / ì €í•­ (0.382 ~ 0.500 Ã— ATR)</div>
        <div class="zone r">
          <div class="zl">ì €í•­ L1</div>
          <div class="zv"><span id="R2">-</span><span class="sep">~</span><span id="R1">-</span></div>
        </div>
        <div class="pivot-row">
          <div class="pivot-label">â–¶ CENTER (HMA 200 Â· 15m)</div>
          <div class="pivot-val" id="mCenter">-</div>
        </div>
        <div class="zone s">
          <div class="zl">ì§€ì§€ L1</div>
          <div class="zv"><span id="S2">-</span><span class="sep">~</span><span id="S1">-</span></div>
        </div>
      </div>
      <div class="c">
        <div class="c-title">ğŸ“ L1 Ext â€” 1ì°¨ í™•ì¥ (0.618 ~ 0.786 Ã— ATR)</div>
        <div class="zone r-ext">
          <div class="zl">ì €í•­ L1 Ext</div>
          <div class="zv"><span id="R4">-</span><span class="sep">~</span><span id="R3">-</span></div>
        </div>
        <div class="zone s-ext">
          <div class="zl">ì§€ì§€ L1 Ext</div>
          <div class="zv"><span id="S4">-</span><span class="sep">~</span><span id="S3">-</span></div>
        </div>
      </div>
      <div class="c">
        <div class="c-title">ğŸ”¶ L2 â€” 2ì°¨ í™•ì¥ (1.000 ~ 1.272 Ã— ATR)</div>
        <div class="zone r-l2">
          <div class="zl">ì €í•­ L2 <span style="font-weight:400;font-size:9px;color:var(--dim)">Â· ìˆ ì§„ì… ì°¸ê³ </span></div>
          <div class="zv"><span id="R6">-</span><span class="sep">~</span><span id="R5">-</span></div>
        </div>
        <div class="zone s-l2">
          <div class="zl">ì§€ì§€ L2 <span style="font-weight:400;font-size:9px;color:var(--dim)">Â· ë¡± ì¶”ê°€ì§„ì… ì°¸ê³ </span></div>
          <div class="zv"><span id="S6">-</span><span class="sep">~</span><span id="S5">-</span></div>
        </div>
        <div style="font-size:10px;color:var(--dim);margin-top:6px;line-height:1.5;padding:0 4px">
          â€» ATR 1ë°° ì´ìƒ í™•ì¥ Â· ê¸‰ë³€ë™ ì‹œ ìˆ/ë¡± ì°¸ê³ ìš© Â· ë°±í…ŒìŠ¤íŠ¸ ê²€ì¦ ê¶Œì¥
        </div>
      </div>
      <div class="c">
        <div class="c-title">ì „ì¼ ì¼ë´‰ ê¸°ì¤€ (Binance BTCUSDT Futures)</div>
        <div class="mg">
          <div class="mc"><div class="k">ì‹œê°€</div><div class="v" id="mO">-</div></div>
          <div class="mc"><div class="k">ê³ ê°€</div><div class="v" id="mH">-</div></div>
          <div class="mc"><div class="k">ì €ê°€</div><div class="v" id="mL">-</div></div>
          <div class="mc"><div class="k">ì¢…ê°€</div><div class="v" id="mC">-</div></div>
          <div class="mc"><div class="k">ATR(10)</div><div class="v" id="mA">-</div></div>
          <div class="mc"><div class="k">ê¸°ì¤€ì¼</div><div class="v" id="mD">-</div></div>
        </div>
      </div>
      <details class="c" style="cursor:pointer">
        <summary style="font-size:11px;color:var(--dim);font-weight:700">ğŸ“ ê³„ì‚° ê³µì‹</summary>
        <div style="margin-top:10px;font-size:11px;color:var(--dim);line-height:2.3;font-family:var(--mono)">
          <span style="color:var(--amber)">Center = HMA 200 (15ë¶„ë´‰ 500ê°œ)</span><br>
          <b style="color:var(--red)">L1:</b> Â± 0.382Ã—ATR ~ Â± 0.500Ã—ATR<br>
          <b style="color:rgba(231,76,90,.55)">L1 Ext:</b> Â± 0.618Ã—ATR ~ Â± 0.786Ã—ATR<br>
          <b style="color:#ff9800">L2:</b> Â± 1.000Ã—ATR ~ Â± 1.272Ã—ATR
        </div>
      </details>
    </div>
    <div id="errToday" class="err" style="display:none"></div>
  </div>

  <!-- â•â•â• TAB 1: ì°¨íŠ¸ â•â•â• -->
  <div class="pane" id="p1">
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
      <button class="ext-btn" onclick="App.openBinanceChart()">ğŸ”— ë°”ì´ë‚¸ìŠ¤ ì°¨íŠ¸ ì—´ê¸°</button>
    </div>
    <div class="chart-ctrl-bar">
      <div class="chart-ctrl-left">
        <button id="btnL1"  class="zone-btn" onclick="App.toggleL1()">L1</button>
        <button id="btnL1E" class="zone-btn" onclick="App.toggleL1E()">L1 Ext</button>
        <button id="btnL2"  class="zone-btn l2" onclick="App.toggleL2()">L2</button>
      </div>
      <div class="chart-ctrl-right">
        <input type="date" id="srDateInput" class="date-input">
        <button class="ctrl-btn" onclick="App.loadHistSR()">ê³¼ê±° S/R</button>
        <button class="ctrl-btn accent" onclick="App.resetToLive()">ì‹¤ì‹œê°„</button>
      </div>
    </div>
    <div id="histSrStatus" class="hist-status"></div>
    <div class="chart-wrap">
      <div class="tf-bar">
        <button class="tf" data-tf="15m">15m</button>
        <button class="tf on" data-tf="1h">1H</button>
        <button class="tf" data-tf="4h">4H</button>
        <button class="tf" data-tf="1d">1D</button>
      </div>
      <div class="chart-legend">
        <div class="leg"><div class="leg-dot" style="background:var(--amber)"></div>HMA</div>
        <div class="leg"><div class="leg-dot" style="background:var(--red)"></div>L1</div>
        <div class="leg"><div class="leg-dot" style="background:rgba(231,76,90,.4)"></div>L1Ext</div>
        <div class="leg"><div class="leg-dot" style="background:#ff9800"></div>L2</div>
      </div>
      <div id="chart"></div>
      <div class="rsi-sub-header">
        <span id="rsi-val" style="font-family:var(--mono);font-size:12px"></span>
        <span style="font-size:9px;color:var(--dim)">RSI(14) Â· <span style="color:#a78bfa">ë³´ë¼</span>=RSI Â· <span style="color:#f59e0b">ë…¸ë‘</span>=SMA</span>
      </div>
      <div id="rsi-chart"></div>
    </div>
    <div class="c" style="padding:10px 14px">
      <div style="font-size:11px;color:var(--dim)">ğŸ’¡ ë°•ìŠ¤ ì¡´ì€ <b>í•´ë‹¹ ë‚ ì§œ êµ¬ê°„ë§Œ</b> í‘œì‹œ Â· L2 = ìˆ/ë¡± ì¶”ê°€ì§„ì… ì°¸ê³ </div>
    </div>
  </div>

  <!-- â•â•â• TAB 2: íˆìŠ¤í† ë¦¬ â•â•â• -->
  <div class="pane" id="p2">
    <div class="fbar">
      <button class="fb on" onclick="History.filter('1w',this)">1ì£¼</button>
      <button class="fb"    onclick="History.filter('1m',this)">1ë‹¬</button>
      <button class="fb"    onclick="History.filter('all',this)">ì „ì²´</button>
    </div>
    <div id="histLoad" class="ld"><div class="sp"></div></div>
    <div id="histList" class="scroll"></div>
    <div id="histEmpty" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ë°ì´í„° ì—†ìŒ</div>
  </div>

  <!-- â•â•â• TAB 3: ê±°ë˜ëŸ‰ â•â•â• -->
  <div class="pane" id="p3">
    <div class="c">
      <div class="c-title">ğŸ“Š ê±°ë˜ëŸ‰ ëª¨ë‹ˆí„°</div>
      <div class="tog-row">
        <span style="font-size:12px;font-weight:700">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</span>
        <div>
          <span id="vstat" style="font-size:11px;color:var(--dim);margin-right:8px">ì¤‘ì§€ë¨</span>
          <div class="tog-sw" id="vtog" onclick="Volume.toggle()"></div>
        </div>
      </div>
      <div style="display:flex;gap:6px;margin-bottom:8px">
        <button class="btn-ghost" onclick="Volume.toggleSnd()" id="sndBtn" style="font-size:11px">ğŸ”• ì•Œë¦¼ìŒ</button>
        <button class="btn-ghost" onclick="Volume.clear()" style="font-size:11px">ğŸ—‘ ì´ˆê¸°í™”</button>
      </div>
    </div>
    <div id="valList" class="scroll"></div>
    <div id="valEmpty" class="empty"><div class="ei">ğŸ“Š</div>ëª¨ë‹ˆí„°ë§ ì‹œì‘ í›„ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
  </div>

  <!-- â•â•â• TAB 4: ê¸‰ë½íƒì§€ â•â•â• -->
  <div class="pane" id="p4">
    <div class="c">
      <div class="c-title">ğŸ“‰ ê¸‰ë½ êµ¬ê°„ íƒì§€</div>
      <div style="margin-bottom:12px">
        <div style="font-size:10px;color:var(--dim);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">íƒì§€ ê¸°ê°„</div>
        <div class="crash-win-bar">
          <button class="crash-win-btn" onclick="Crash.setWindow('12h',this)">12ì‹œê°„</button>
          <button class="crash-win-btn on" onclick="Crash.setWindow('24h',this)">24ì‹œê°„</button>
          <button class="crash-win-btn" onclick="Crash.setWindow('3d',this)">3ì¼</button>
        </div>
      </div>
      <div class="crash-control">
        <div class="crash-ctrl-top">
          <span class="crash-ctrl-label">ë‚™í­ ê¸°ì¤€</span>
          <span class="crash-thresh-display"><span id="crashThreshVal">10%</span> ì´ìƒ</span>
        </div>
        <input type="range" id="crashSlider" class="crash-slider" min="3" max="50" step="1" value="10">
        <div class="crash-slider-ticks"><span>3%</span><span>10%</span><span>20%</span><span>30%</span><span>50%</span></div>
      </div>
      <div class="crash-ctrl-row">
        <div class="crash-direct">
          <span style="font-size:11px;color:var(--dim)">ì§ì ‘ ì…ë ¥:</span>
          <input type="number" id="crashInput" class="crash-input" min="3" max="50" step="0.5" value="10" placeholder="%">
          <span style="font-size:11px;color:var(--dim)">%</span>
        </div>
        <button class="btn-primary" onclick="Crash.run()" style="padding:7px 18px;font-size:12px">ğŸ” íƒìƒ‰</button>
      </div>
      <div style="font-size:10px;color:var(--dim);margin-top:8px;line-height:1.5">
        â€» 4ì‹œê°„ë´‰ 1,500ê°œ (~250ì¼) Â· ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬ ë™ë°˜ ì—¬ë¶€ ìë™ ë¶„ì„<br>
        <span style="color:var(--amber)">ğŸ”¥ 3Ã—â†‘</span> = ê°•í•œ ê±°ë˜ëŸ‰ Â· <span style="color:var(--dim)">âš¡ 2Ã—â†‘</span> = ì£¼ì˜ ê±°ë˜ëŸ‰
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 2px 8px">
      <div class="c-title" style="margin:0">íƒì§€ ê²°ê³¼</div>
      <div id="crashCount" style="font-family:var(--mono);font-size:11px;color:var(--amber);font-weight:700"></div>
    </div>
    <div id="crashLoad" class="ld" style="display:none"><div class="sp"></div><div style="margin-top:6px">ë¶„ì„ ì¤‘...</div></div>
    <div id="crashList" class="scroll" style="max-height:none"></div>
    <div id="crashEmpty" class="empty"><div class="ei">ğŸ”</div><span>íƒìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</span></div>
  </div>

  <!-- â•â•â• TAB 5: í€ë”©ë¹„ â•â•â• -->
  <div class="pane" id="p5">
    <div class="c">
      <div class="c-title">ğŸ’° ë°”ì´ë¹„íŠ¸ í€ë”©ë¹„ (BTCUSDT)</div>
      <div style="font-size:11px;color:var(--dim);margin-bottom:10px;line-height:1.5">
        Bybit ê³µê°œ API Â· API í‚¤ ë¶ˆí•„ìš” Â· 8ì‹œê°„ ê°„ê²©<br>
        <span style="color:var(--green)">ì–‘ìˆ˜</span> = ë¡±â†’ìˆ ì§€ê¸‰ Â·
        <span style="color:var(--red)">ìŒìˆ˜</span> = ìˆâ†’ë¡± ì§€ê¸‰
      </div>
      <div class="fund-calc-row">
        <span style="font-size:11px;font-weight:700">í¬ì§€ì…˜ í¬ê¸°:</span>
        <span style="font-size:11px;color:var(--dim)">$</span>
        <input type="number" id="fund-pos-size" class="fund-pos-input" value="10000" min="100" step="1000">
        <span style="font-size:10px;color:var(--dim)">(ìë™ ì €ì¥)</span>
      </div>
      <div class="fund-date-row">
        <span style="font-size:11px;font-weight:700">ë‚ ì§œ ë²”ìœ„:</span>
        <input type="date" id="fund-from" class="date-input">
        <span style="font-size:11px;color:var(--dim)">~</span>
        <input type="date" id="fund-to" class="date-input">
        <button class="ctrl-btn" onclick="document.getElementById('fund-from').value='';document.getElementById('fund-to').value='';Funding.render();" style="font-size:10px;padding:4px 8px">ì´ˆê¸°í™”</button>
      </div>
      <div id="fund-status" class="hist-status" style="margin-top:6px"></div>
    </div>
    <div id="fund-summary"></div>
    <div id="fund-list" class="scroll" style="max-height:none"></div>
  </div>

  <!-- â•â•â• TAB 6: ë§¤ë§¤ì‹ í˜¸ â•â•â• -->
  <div class="pane" id="p6">
    <div class="c">
      <div class="c-title">ğŸ“Š HMA í¬ë¡œìŠ¤ ë§¤ë§¤ ì‹ í˜¸</div>
      <div style="font-size:11px;color:var(--dim);line-height:1.5;margin-bottom:8px">
        HMA 60 (ë‹¨ê¸°ğŸŸ¢) Ã— HMA 200 (ì¥ê¸°ğŸ”´) í¬ë¡œìŠ¤ ê¸°ë°˜ ë§¤ë§¤ ì‹ í˜¸<br>
        SL = ATR(14) on 15m Â· TP = 0.5Ã—~5.0Ã— SL ê±°ë¦¬
      </div>
      <div id="sig-current"></div>
      <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
        <button class="btn-primary" onclick="Signal.scan()">ğŸ” ìŠ¤ìº”</button>
        <button class="ctrl-btn" id="sig-mon-btn" onclick="Signal.toggleMonitor()">â–¶ï¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
        <button class="ctrl-btn" onclick="Signal.clear()" style="font-size:10px;color:var(--dim)">ğŸ—‘ ì´ˆê¸°í™”</button>
      </div>
      <div id="sig-status" class="hist-status" style="margin-top:6px"></div>
    </div>
    <div id="sig-list"></div>
  </div>

  <!-- â•â•â• TAB 7: ìˆ ì‹œê·¸ë„ â•â•â• -->
  <div class="pane" id="p7">
    <div class="c">
      <div class="c-title">ğŸ“‰ ìˆ í¬ì§€ì…˜ ì‹œê·¸ë„</div>
      <div style="font-size:11px;color:var(--dim);margin-bottom:8px;line-height:1.5">
        Fear & Greed Â· ë¯¸ê²°ì œì•½ì •(OI) Â· í€ë”©ë¹„ë¥¼ ì¢…í•© ë¶„ì„í•˜ì—¬ ìˆ/ë¡± ì‹œê·¸ë„ì„ íŒë‹¨í•©ë‹ˆë‹¤.
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <div id="ss-status" class="hist-status"></div>
        <button class="ctrl-btn" onclick="ShortSignal.refresh()" style="font-size:10px;padding:4px 10px">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div id="ss-content"></div>
  </div>

  <!-- â•â•â• TAB 8: ë°±í…ŒìŠ¤íŠ¸ â•â•â• -->
  <div class="pane" id="p8">
    <div class="c">
      <div class="c-title">ğŸ§ª S/R Zone ë°±í…ŒìŠ¤íŠ¸</div>
      <div style="font-size:12px;color:var(--dim);line-height:1.7;margin-bottom:10px">
        L1 Â· L1 Ext Â· L2 ì¡´ì˜ <b>í„°ì¹˜/ë°˜ì „/ëŒíŒŒìœ¨</b>ì„ ê²€ì¦í•©ë‹ˆë‹¤.<br>
        <span style="color:var(--amber)">60%â†‘</span> = ìœ ì˜ë¯¸ Â·
        <span style="color:var(--red)">40%â†“</span> = ì‹ ë¢°ë„ ë‚®ìŒ
      </div>
      <div style="margin-bottom:12px">
        <div style="font-size:10px;color:var(--dim);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">ë¶„ì„ ê¸°ê°„</div>
        <div class="bt-period-bar">
          <button class="bt-period-btn" onclick="Backtest.setPeriod('2w',this)">2ì£¼</button>
          <button class="bt-period-btn on" onclick="Backtest.setPeriod('1m',this)">1ê°œì›”</button>
        </div>
        <div style="font-size:10px;color:var(--dim);margin-top:4px">
          â€» 1ê°œì›” = 15ë¶„ë´‰ ~2,900ê°œ (API 2íšŒ í˜¸ì¶œ, ì•½ 10ì´ˆ ì†Œìš”)
        </div>
      </div>
      <button class="btn-primary" onclick="Backtest.run()">ğŸ”¬ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      <div id="bt-status" class="hist-status" style="margin-top:8px"></div>
    </div>
    <div id="bt-results"></div>
  </div>

  <!-- â•â•â• TAB 9: íˆíŠ¸ë§µ â•â•â• -->
  <div class="pane" id="p9">
    <div class="c">
      <div class="c-title">ğŸ—“ BTC ì›”ë³„ ìˆ˜ìµë¥  íˆíŠ¸ë§µ</div>
      <div style="font-size:11px;color:var(--dim);line-height:1.5;margin-bottom:6px">
        Binance BTCUSDT ì›”ë´‰ ê¸°ì¤€ Â· ì‹œê°€â†’ì¢…ê°€ ìˆ˜ìµë¥  (%) Â· ìµœì‹ ìˆœ ì •ë ¬
      </div>
      <div id="hm-status" class="hist-status"></div>
    </div>
    <div id="hm-table"></div>
  </div>

</div>

<script>
/* ---- config.js ---- */
// ============================================================
// CONFIG.JS â€” ì„¤ì • / API í‚¤ / ìƒìˆ˜
// ============================================================
const Config = (() => {
  const SYM         = 'BTCUSDT';
  const ATR_P       = 10;
  const HMA_PERIOD  = 200;
  const HMA_TF      = '15m';
  const HMA_LIMIT   = 500;
  const FI          = 0.382;     // L1 inner
  const FO          = 0.500;     // L1 outer
  const L1E_F1      = 0.618;    // L1 Ext inner
  const L1E_F2      = 0.786;    // L1 Ext outer
  const L2_F1       = 1.000;    // L2 inner
  const L2_F2       = 1.272;    // L2 outer
  const VOL_TH      = 2000;

  const LS_KEY      = 'btc_api_key';
  function getApiKey() { return localStorage.getItem(LS_KEY) || ''; }
  function setApiKey(key) {
    if (key) localStorage.setItem(LS_KEY, key.trim());
    else localStorage.removeItem(LS_KEY);
  }

  return {
    SYM, ATR_P, HMA_PERIOD, HMA_TF, HMA_LIMIT,
    FI, FO, L1E_F1, L1E_F2, L2_F1, L2_F2,
    VOL_TH, getApiKey, setApiKey
  };
})();


/* ---- api.js ---- */
// ============================================================
// API.JS â€” Binance API í˜¸ì¶œ (API Key ì„ íƒ ì§€ì›)
// ============================================================
const API = (() => {

  // Public endpoints: API Key ë¶ˆí•„ìš”í•˜ë‚˜, í—¤ë”ì— í¬í•¨í•´ë‘ë©´ rate limit í˜œíƒ
  async function call(path, params = {}) {
    const qs   = new URLSearchParams(params).toString();
    const key  = Config.getApiKey();
    const hdrs = key ? { 'X-MBX-APIKEY': key } : {};

    const bases = [
      `https://fapi.binance.com/fapi/v1/${path}`,
      `https://api.binance.com/api/v3/${path}`
    ];

    for (const base of bases) {
      try {
        const r = await fetch(`${base}?${qs}`, { headers: hdrs });
        if (r.ok) return await r.json();
      } catch { continue; }
    }
    throw new Error('Binance API ì ‘ì† ë¶ˆê°€');
  }

  // ìº”ë“¤ íŒŒì‹± (ì¼ë´‰ìš©)
  function parseDailyKlines(raw) {
    return raw.map(k => ({
      openTime: k[0],
      date:     new Date(k[0]),
      open:  +k[1], high:  +k[2],
      low:   +k[3], close: +k[4],
      volume:+k[5]
    }));
  }

  // ìµœì‹  ê°€ê²©
  async function tickerPrice(sym) {
    const d = await call('ticker/price', { symbol: sym });
    return +d.price;
  }

  // ìº”ë“¤ (ë²”ìš©)
  async function klines(sym, interval, limit) {
    return call('klines', { symbol: sym, interval, limit });
  }

  return { call, parseDailyKlines, tickerPrice, klines };
})();


/* ---- hma.js ---- */
// ============================================================
// HMA.JS â€” Hull Moving Average ê³„ì‚°
// ============================================================
const HMA = (() => {

  function wma(prices, period) {
    const w = period * (period + 1) / 2;
    const out = [];
    for (let i = period - 1; i < prices.length; i++) {
      let s = 0;
      for (let j = 0; j < period; j++) s += prices[i - period + 1 + j] * (j + 1);
      out.push(s / w);
    }
    return out;
  }

  function hma(prices, period) {
    const half   = Math.floor(period / 2);
    const sqr    = Math.floor(Math.sqrt(period));
    const wh     = wma(prices, half);
    const wf     = wma(prices, period);
    const offset = period - half;
    const diff   = [];
    for (let i = 0; i < wf.length; i++) {
      diff.push(2 * wh[i + offset] - wf[i]);
    }
    return wma(diff, sqr);
  }

  // ìº”ë“¤ ë°°ì—´ â†’ { time, value }[] í˜•íƒœ ë°˜í™˜
  function fromCandles(candles, period) {
    const prices   = candles.map(c => c.close);
    const hmaVals  = hma(prices, period);
    const startIdx = candles.length - hmaVals.length;
    return hmaVals.map((v, i) => ({
      time:  candles[startIdx + i].time,
      value: v
    }));
  }

  // ê°€ì¥ ìµœì‹  HMA ê°’ ë°˜í™˜ (float)
  function latestValue(candles, period) {
    const prices  = candles.map(c => c.close);
    const hmaVals = hma(prices, period);
    return hmaVals[hmaVals.length - 1];
  }

  return { fromCandles, latestValue };
})();


/* ---- sr.js ---- */
// ============================================================
// SR.JS â€” HMA ê¸°ë°˜ ì§€ì§€/ì €í•­ (L1 + L1 Ext + L2)
//
// L1      0.382 ~ 0.500   ê¸°ë³¸ êµ¬ê°„
// L1 Ext  0.618 ~ 0.786   1ì°¨ í™•ì¥
// L2      1.000 ~ 1.272   2ì°¨ í™•ì¥ (ê¸‰ë³€ë™ / ìˆ ì°¸ê³ )
// ============================================================
const SR = (() => {

  function calcTR(candles) {
    for (let i = 0; i < candles.length; i++) {
      const c = candles[i];
      c.tr = i === 0
        ? c.high - c.low
        : Math.max(c.high - c.low, Math.abs(c.high - candles[i-1].close), Math.abs(c.low - candles[i-1].close));
    }
  }

  function calcATR(candles, idx, p) {
    if (idx < p - 1) return null;
    let s = 0;
    for (let i = idx - p + 1; i <= idx; i++) s += candles[i].tr;
    return s / p;
  }

  function buildLevels(center, atr) {
    const { FI, FO, L1E_F1, L1E_F2, L2_F1, L2_F2 } = Config;
    return {
      center, atr,
      // L1
      r1: center + FI     * atr, r2: center + FO     * atr,
      s1: center - FI     * atr, s2: center - FO     * atr,
      // L1 Ext
      r3: center + L1E_F1 * atr, r4: center + L1E_F2 * atr,
      s3: center - L1E_F1 * atr, s4: center - L1E_F2 * atr,
      // L2
      r5: center + L2_F1  * atr, r6: center + L2_F2  * atr,
      s5: center - L2_F1  * atr, s6: center - L2_F2  * atr,
    };
  }

  async function compute() {
    const { SYM, ATR_P, HMA_PERIOD, HMA_TF, HMA_LIMIT, FO, FI, L1E_F1, L1E_F2, L2_F1, L2_F2 } = Config;

    const raw15m = await API.klines(SYM, HMA_TF, HMA_LIMIT);
    const candles15m = raw15m.map(k => ({
      time: k[0]/1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4]
    }));
    const hmaCenterValue = HMA.latestValue(candles15m, HMA_PERIOD);

    const rawD  = await API.klines(SYM, '1d', 60);
    const daily = API.parseDailyKlines(rawD);
    calcTR(daily);

    const todayUTC = new Date().toISOString().split('T')[0];
    const lastDate = daily[daily.length-1].date.toISOString().split('T')[0];
    const prevIdx  = lastDate === todayUTC ? daily.length-2 : daily.length-1;
    const prev     = daily[prevIdx];
    const atr      = calcATR(daily, prevIdx, ATR_P);
    if (!atr) throw new Error('ATR ê³„ì‚° ë¶ˆê°€');

    const levels = buildLevels(hmaCenterValue, atr);

    // íˆìŠ¤í† ë¦¬ (ì¢…ê°€ ê¸°ë°˜ â€” ê³¼ê±° ì‹¤ì‹œê°„ HMA ì¬ê³„ì‚° ë¶ˆê°€)
    const hist = [];
    for (let i = ATR_P; i <= prevIdx; i++) {
      const c = daily[i], a = calcATR(daily, i, ATR_P);
      if (!a) continue;
      const nd = new Date(c.openTime + 86400000);
      const ctr = c.close;
      hist.push({
        date: nd, ds: `${nd.getUTCMonth()+1}ì›” ${nd.getUTCDate()}ì¼`,
        // L1
        r2: Math.round(ctr + FO * a), r1: Math.round(ctr + FI * a),
        s1: Math.round(ctr - FI * a), s2: Math.round(ctr - FO * a),
        // L1 Ext
        r4: Math.round(ctr + L1E_F2 * a), r3: Math.round(ctr + L1E_F1 * a),
        s3: Math.round(ctr - L1E_F1 * a), s4: Math.round(ctr - L1E_F2 * a),
        // L2
        r6: Math.round(ctr + L2_F2 * a), r5: Math.round(ctr + L2_F1 * a),
        s5: Math.round(ctr - L2_F1 * a), s6: Math.round(ctr - L2_F2 * a),
        cl: Math.round(ctr), atr: Math.round(a), note: 'close'
      });
    }
    hist.reverse();

    return {
      levels,
      prev: { open: prev.open, high: prev.high, low: prev.low, close: prev.close, atr, date: prev.date },
      hist, candles15m
    };
  }

  async function computeHistorical(targetTime) {
    const { SYM, ATR_P, HMA_PERIOD, HMA_TF, HMA_LIMIT } = Config;
    const raw15m = await API.call('klines', { symbol: SYM, interval: HMA_TF, limit: HMA_LIMIT, endTime: targetTime });
    const candles15m = raw15m.map(k => ({ time: k[0]/1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4] }));
    if (candles15m.length < HMA_PERIOD) throw new Error('15m ë°ì´í„° ë¶€ì¡±');
    const center = HMA.latestValue(candles15m, HMA_PERIOD);

    const rawD = await API.call('klines', { symbol: SYM, interval: '1d', limit: 60, endTime: targetTime });
    const daily = API.parseDailyKlines(rawD);
    calcTR(daily);
    const idx = daily.length - 2;
    if (idx < ATR_P - 1) throw new Error('ì¼ë´‰ ë°ì´í„° ë¶€ì¡±');
    const atr = calcATR(daily, idx, ATR_P);

    return { levels: buildLevels(center, atr), candles15m };
  }

  function _calcTR(c) { calcTR(c); }
  function _calcATR(c, i, p) { return calcATR(c, i, p); }

  return { compute, computeHistorical, buildLevels, _calcTR, _calcATR };
})();


/* ---- chart-module.js ---- */
// ============================================================
// CHART-MODULE.JS â€” ì°¨íŠ¸ + S/R ë°•ìŠ¤ (í•´ë‹¹ ë‚ ì§œ êµ¬ê°„ë§Œ í‘œì‹œ)
// L1 / L1 Ext / L2 ì„¸ ë‹¨ê³„ í† ê¸€
// ============================================================
const ChartModule = (() => {
  let chartObj, cSeries, hmLine, hmLineShort, volSeries;
  let rsiChart, rsiLine, rsiSmaLine;
  let syncing = false;
  let curTF     = '1h';
  let srLevels  = null;
  let srDate    = null;
  let showL1    = false;
  let showL1E   = false;
  let showL2    = false;
  let boxCanvas = null;
  let chartEl   = null;

  function init(containerId) {
    chartEl = document.getElementById(containerId);
    chartObj = LightweightCharts.createChart(chartEl, {
      width: chartEl.clientWidth, height: 420,
      layout:    { background: { color: '#0f1219' }, textColor: '#8893a6' },
      grid:      { vertLines: { color: '#1c2233' }, horzLines: { color: '#1c2233' } },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#1c2233' },
      rightPriceScale: { borderColor: '#1c2233' },
    });
    cSeries = chartObj.addCandlestickSeries({
      upColor: '#2db87e', downColor: '#e74c5a',
      borderVisible: false, wickUpColor: '#2db87e', wickDownColor: '#e74c5a'
    });
    hmLine = chartObj.addLineSeries({
      color: '#991b1b', lineWidth: 2, lastValueVisible: true, priceLineVisible: false
    });
    hmLineShort = chartObj.addLineSeries({
      color: '#22c55e', lineWidth: 2, lastValueVisible: true, priceLineVisible: false
    });
    volSeries = chartObj.addHistogramSeries({
      color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: ''
    });
    volSeries.priceScale().applyOptions({ scaleMargins: { top: 0.85, bottom: 0 } });

    boxCanvas = document.createElement('canvas');
    boxCanvas.style.cssText = 'position:absolute;top:0;left:0;pointer-events:none;z-index:5;';
    chartEl.style.position = 'relative';
    chartEl.appendChild(boxCanvas);

    const resize = () => {
      const w = chartEl.clientWidth, h = 420, dpr = window.devicePixelRatio || 1;
      chartObj.applyOptions({ width: w, height: h });
      boxCanvas.width = w * dpr; boxCanvas.height = h * dpr;
      boxCanvas.style.width = w + 'px'; boxCanvas.style.height = h + 'px';
      drawBoxes();
    };
    new ResizeObserver(resize).observe(chartEl);
    setTimeout(resize, 100);
    chartObj.timeScale().subscribeVisibleTimeRangeChange(() => requestAnimationFrame(drawBoxes));

    // â”€â”€ RSI ì„œë¸Œì°¨íŠ¸ â”€â”€
    const rsiEl = document.getElementById('rsi-chart');
    if (rsiEl) {
      rsiChart = LightweightCharts.createChart(rsiEl, {
        width: rsiEl.clientWidth, height: 120,
        layout: { background: { color: '#0f1219' }, textColor: '#8893a6' },
        grid: { vertLines: { color: '#1c2233' }, horzLines: { color: '#1c2233' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#1c2233', visible: false },
        rightPriceScale: { borderColor: '#1c2233', scaleMargins: { top: 0.05, bottom: 0.05 } },
      });
      rsiLine = rsiChart.addLineSeries({
        color: '#a78bfa', lineWidth: 1.5, lastValueVisible: true, priceLineVisible: false
      });
      rsiSmaLine = rsiChart.addLineSeries({
        color: '#f59e0b', lineWidth: 1, lastValueVisible: false, priceLineVisible: false, lineStyle: 2
      });

      // 70/30 ê¸°ì¤€ì„ 
      const ob = rsiChart.addLineSeries({ color: 'rgba(231,76,90,.35)', lineWidth: 1, lineStyle: 2, lastValueVisible: false, priceLineVisible: false });
      const os = rsiChart.addLineSeries({ color: 'rgba(45,184,126,.35)', lineWidth: 1, lineStyle: 2, lastValueVisible: false, priceLineVisible: false });
      // ë”ë¯¸ ë°ì´í„° (load ì‹œ ì‹¤ì œ ì‹œê°„ì— ë§ì¶° ê°±ì‹ )
      rsiChart._obLine = ob;
      rsiChart._osLine = os;

      // ì‹œê°„ì¶• ë™ê¸°í™”
      chartObj.timeScale().subscribeVisibleLogicalRangeChange(range => {
        if (syncing || !range) return;
        syncing = true;
        rsiChart.timeScale().setVisibleLogicalRange(range);
        syncing = false;
      });
      rsiChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
        if (syncing || !range) return;
        syncing = true;
        chartObj.timeScale().setVisibleLogicalRange(range);
        syncing = false;
      });

      // ë¦¬ì‚¬ì´ì¦ˆ
      const rsiResize = () => {
        rsiChart.applyOptions({ width: rsiEl.clientWidth, height: 120 });
      };
      new ResizeObserver(rsiResize).observe(rsiEl);
    }
  }

  function setSRLevels(levels, dateOverride) {
    srLevels = levels;
    srDate = dateOverride || null;
    drawBoxes();
  }

  function setShowL1(v)  { showL1  = v; drawBoxes(); }
  function setShowL1E(v) { showL1E = v; drawBoxes(); }
  function setShowL2(v)  { showL2  = v; drawBoxes(); }
  function getVisibility() { return { l1: showL1, l1e: showL1E, l2: showL2 }; }

  function getDayRange() {
    const d = srDate ? new Date(srDate) : new Date();
    const start = Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()) / 1000;
    return { start, end: start + 86400 };
  }

  function drawBoxes() {
    if (!boxCanvas || !chartObj || !cSeries) return;
    const ctx = boxCanvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    ctx.clearRect(0, 0, boxCanvas.width, boxCanvas.height);
    if ((!showL1 && !showL1E && !showL2) || !srLevels) return;

    ctx.save();
    ctx.scale(dpr, dpr);

    const ts = chartObj.timeScale();
    const { start, end } = getDayRange();
    const xS = ts.timeToCoordinate(start);
    const xE = ts.timeToCoordinate(end);
    if (xS === null && xE === null) { ctx.restore(); return; }

    const canvasW = boxCanvas.width / dpr;
    const bL = Math.max(xS !== null ? xS : 0, 0);
    const bR = Math.min(xE !== null ? xE : canvasW, canvasW);
    const bW = bR - bL;
    if (bW <= 2) { ctx.restore(); return; }

    function drawZone(top, bot, fill, stroke, labelText) {
      const yT = cSeries.priceToCoordinate(top);
      const yB = cSeries.priceToCoordinate(bot);
      if (yT === null || yB === null) return;
      const y = Math.min(yT, yB), h = Math.abs(yB - yT);
      if (h < 1) return;
      ctx.fillStyle = fill;
      ctx.fillRect(bL, y, bW, h);
      ctx.strokeStyle = stroke; ctx.lineWidth = 1.5; ctx.setLineDash([]);
      ctx.strokeRect(bL, y, bW, h);
      ctx.font = 'bold 10px "IBM Plex Mono", monospace';
      ctx.fillStyle = stroke;
      const txt = fmtN(top) + ' ~ ' + fmtN(bot);
      const tw = ctx.measureText(txt).width;
      ctx.fillText(txt, bL + (bW - tw) / 2, y - 4);
    }

    // L1 (0.382~0.500) â€” ì§„í•œ ë¹¨ê°•/ì´ˆë¡
    if (showL1) {
      drawZone(srLevels.r2, srLevels.r1,
        'rgba(231,76,90,0.18)', 'rgba(231,76,90,0.75)', '');
      drawZone(srLevels.s1, srLevels.s2,
        'rgba(45,184,126,0.18)', 'rgba(45,184,126,0.75)', '');
    }

    // L1 Ext (0.618~0.786) â€” ì—°í•œ ë¹¨ê°•/ì´ˆë¡
    if (showL1E) {
      drawZone(srLevels.r4, srLevels.r3,
        'rgba(231,76,90,0.08)', 'rgba(231,76,90,0.40)', '');
      drawZone(srLevels.s3, srLevels.s4,
        'rgba(45,184,126,0.08)', 'rgba(45,184,126,0.40)', '');
    }

    // L2 (1.000~1.272) â€” ì£¼í™©/ì²­ë¡
    if (showL2) {
      drawZone(srLevels.r6, srLevels.r5,
        'rgba(255,152,0,0.12)', 'rgba(255,152,0,0.55)', '');
      drawZone(srLevels.s5, srLevels.s6,
        'rgba(0,188,212,0.12)', 'rgba(0,188,212,0.55)', '');
    }

    // Center ì ì„ 
    const yC = cSeries.priceToCoordinate(srLevels.center);
    if (yC !== null) {
      ctx.setLineDash([6, 3]);
      ctx.strokeStyle = 'rgba(239,180,32,0.75)'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(bL, yC); ctx.lineTo(bL + bW, yC); ctx.stroke();
      ctx.setLineDash([]);
      ctx.font = 'bold 10px "IBM Plex Mono", monospace';
      ctx.fillStyle = 'rgba(239,180,32,0.9)';
      ctx.fillText('HMA ' + fmtN(srLevels.center), bL + 4, yC - 5);
    }

    ctx.restore();
  }

  function fmtN(n) { return n.toLocaleString('en-US', { maximumFractionDigits: 0 }); }

  // â”€â”€ RSI ê³„ì‚° â”€â”€
  function calcRSI(candles, period = 14) {
    const closes = candles.map(c => c.close);
    if (closes.length < period + 1) return [];
    const rsi = [];
    let avgGain = 0, avgLoss = 0;
    for (let i = 1; i <= period; i++) {
      const d = closes[i] - closes[i-1];
      if (d > 0) avgGain += d; else avgLoss -= d;
    }
    avgGain /= period; avgLoss /= period;
    rsi.push({ time: candles[period].time, value: avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss) });
    for (let i = period + 1; i < closes.length; i++) {
      const d = closes[i] - closes[i-1];
      avgGain = (avgGain * (period-1) + Math.max(d,0)) / period;
      avgLoss = (avgLoss * (period-1) + Math.max(-d,0)) / period;
      rsi.push({ time: candles[i].time, value: avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss) });
    }
    return rsi;
  }

  // RSI SMA (signal line)
  function sma(data, period = 14) {
    const out = [];
    for (let i = period - 1; i < data.length; i++) {
      let s = 0;
      for (let j = i - period + 1; j <= i; j++) s += data[j].value;
      out.push({ time: data[i].time, value: s / period });
    }
    return out;
  }

  function setRSIData(candles) {
    if (!rsiChart || !rsiLine) return;
    const rsiData = calcRSI(candles);
    rsiLine.setData(rsiData);
    try { rsiSmaLine.setData(sma(rsiData, 14)); } catch { rsiSmaLine.setData([]); }
    // 70/30 ê¸°ì¤€ì„  (ì „ì²´ ì‹œê°„ ë²”ìœ„)
    if (rsiData.length >= 2 && rsiChart._obLine) {
      const t0 = rsiData[0].time, t1 = rsiData[rsiData.length - 1].time;
      rsiChart._obLine.setData([{ time: t0, value: 70 }, { time: t1, value: 70 }]);
      rsiChart._osLine.setData([{ time: t0, value: 30 }, { time: t1, value: 30 }]);
    }
    // RSI ê°’ í‘œì‹œ
    const el = document.getElementById('rsi-val');
    if (el && rsiData.length) {
      const v = rsiData[rsiData.length - 1].value;
      const c = v >= 70 ? 'var(--red)' : v <= 30 ? 'var(--green)' : '#a78bfa';
      const z = v >= 70 ? 'ê³¼ë§¤ìˆ˜' : v <= 30 ? 'ê³¼ë§¤ë„' : v >= 50 ? 'ê°•ì„¸' : 'ì•½ì„¸';
      el.innerHTML = `<span style="color:${c};font-weight:800">RSI ${v.toFixed(1)}</span> <span style="color:var(--dim);font-size:10px">${z}</span>`;
    }
  }

  async function load(tf) {
    if (tf) curTF = tf;
    if (!chartObj) init('chart');
    const raw = await API.klines(Config.SYM, curTF, 500);
    const candles = raw.map(k => ({ time: k[0]/1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4] }));
    const vols = raw.map(k => ({ time: k[0]/1000, value: +k[5], color: +k[4] >= +k[1] ? 'rgba(45,184,126,.25)' : 'rgba(231,76,90,.25)' }));
    cSeries.setData(candles);
    volSeries.setData(vols);
    try { hmLine.setData(HMA.fromCandles(candles, 200)); } catch { hmLine.setData([]); }
    try { hmLineShort.setData(HMA.fromCandles(candles, 60)); } catch { hmLineShort.setData([]); }
    setRSIData(candles);
    chartObj.timeScale().fitContent();
    drawBoxes();
  }

  async function loadHistorical(candles15m) {
    if (!chartObj) init('chart');
    curTF = '15m';
    document.querySelectorAll('.tf').forEach(b => b.classList.toggle('on', b.dataset.tf === '15m'));
    cSeries.setData(candles15m.map(c => ({ time: c.time, open: c.open, high: c.high, low: c.low, close: c.close })));
    volSeries.setData([]);
    try { hmLine.setData(HMA.fromCandles(candles15m, 200)); } catch { hmLine.setData([]); }
    try { hmLineShort.setData(HMA.fromCandles(candles15m, 60)); } catch { hmLineShort.setData([]); }
    setRSIData(candles15m);
    chartObj.timeScale().fitContent();
    drawBoxes();
  }

  return { init, setSRLevels, setShowL1, setShowL1E, setShowL2, getVisibility, load, loadHistorical };
})();


/* ---- history.js ---- */
// ============================================================
// HISTORY.JS â€” íˆìŠ¤í† ë¦¬ íƒ­ (L1 + L1 Ext + L2 í‘œì‹œ)
// ============================================================
const History = (() => {
  let hist    = [];
  let curFilt = '1w';

  const fmt = n => Math.round(n).toLocaleString('en-US');

  function setData(data) { hist = data; }

  function filter(f, btn) {
    curFilt = f;
    document.querySelectorAll('.fb').forEach(b => b.classList.remove('on'));
    if (btn) btn.classList.add('on');
    render();
  }

  function render() {
    const now  = Date.now();
    let items  = hist;
    if      (curFilt === '1w') items = hist.filter(h => h.date >= new Date(now - 7  * 864e5));
    else if (curFilt === '1m') items = hist.filter(h => h.date >= new Date(now - 30 * 864e5));

    const list  = document.getElementById('histList');
    const empty = document.getElementById('histEmpty');
    document.getElementById('histLoad').style.display = 'none';

    if (!items.length) {
      list.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    list.innerHTML = items.map(h => {
      // L1 Ext / L2 ê°€ ìˆìœ¼ë©´ í‘œì‹œ (ê³¼ê±° ë°ì´í„°ì— í¬í•¨ë¨)
      const hasExt = h.r3 !== undefined;
      const hasL2  = h.r5 !== undefined;

      let extHtml = '';
      if (hasExt) {
        extHtml += `<div class="hl"><span class="ht r ext">ì €í•­ Ext</span><span class="hv">${fmt(h.r4)} ~ ${fmt(h.r3)}</span></div>`;
        extHtml += `<div class="hl"><span class="ht s ext">ì§€ì§€ Ext</span><span class="hv">${fmt(h.s3)} ~ ${fmt(h.s4)}</span></div>`;
      }
      let l2Html = '';
      if (hasL2) {
        l2Html += `<div class="hl"><span class="ht r l2">ì €í•­ L2</span><span class="hv">${fmt(h.r6)} ~ ${fmt(h.r5)}</span></div>`;
        l2Html += `<div class="hl"><span class="ht s l2">ì§€ì§€ L2</span><span class="hv">${fmt(h.s5)} ~ ${fmt(h.s6)}</span></div>`;
      }

      return `
      <div class="hi">
        <div class="hi-d">${h.ds}
          <span>(ì¢…ê°€ ${fmt(h.cl)} / ATR ${fmt(h.atr)}
            ${h.note === 'close' ? '<i style="color:var(--dim);font-size:9px"> â€»ì¢…ê°€ê¸°ì¤€</i>' : ''})
          </span>
        </div>
        <div class="hl"><span class="ht r">ì €í•­ L1</span><span class="hv">${fmt(h.r2)} ~ ${fmt(h.r1)}</span></div>
        <div class="hl"><span class="ht s">ì§€ì§€ L1</span><span class="hv">${fmt(h.s1)} ~ ${fmt(h.s2)}</span></div>
        ${extHtml}
        ${l2Html}
      </div>`;
    }).join('');
  }

  return { setData, filter, render };
})();


/* ---- volume.js ---- */
// ============================================================
// VOLUME.JS â€” ê±°ë˜ëŸ‰ ëª¨ë‹ˆí„°
// ============================================================
const Volume = (() => {
  let vmon   = false;
  let vintv  = null;
  let sndOn  = false;
  let actx   = null;
  let valerts = [];

  const fmt = n => Math.round(n).toLocaleString('en-US');

  function toggle() {
    vmon = !vmon;
    document.getElementById('vtog').classList.toggle('on', vmon);
    const s = document.getElementById('vstat');
    s.textContent = vmon ? 'ëª¨ë‹ˆí„°ë§ ì¤‘...' : 'ì¤‘ì§€ë¨';
    s.style.color  = vmon ? 'var(--green)' : 'var(--dim)';
    if (vmon) { check(); vintv = setInterval(check, 15000); }
    else if (vintv) clearInterval(vintv);
  }

  function toggleSnd() {
    sndOn = !sndOn;
    const btn = document.getElementById('sndBtn');
    btn.textContent = sndOn ? 'ğŸ”” ì•Œë¦¼ìŒ ON' : 'ğŸ”• ì•Œë¦¼ìŒ';
    btn.style.color  = sndOn ? 'var(--amber)' : 'var(--dim)';
    if (sndOn && !actx) actx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function beep(lv) {
    if (!sndOn || !actx) return;
    const o = actx.createOscillator(), g = actx.createGain();
    o.connect(g); g.connect(actx.destination);
    o.frequency.value = 400 + (lv - 2) * 200;
    o.type = 'sine'; g.gain.value = 0.12;
    o.start(); g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + 0.4);
    o.stop(actx.currentTime + 0.4);
  }

  async function check() {
    if (!vmon) return;
    try {
      const raw = await API.klines(Config.SYM, '1m', 3);
      if (!raw || raw.length < 2) return;
      const c   = raw[raw.length - 2];
      const vol = +c[5], pr = +c[4], t = new Date(c[0]);
      if (vol < Config.VOL_TH) return;

      const lk  = Math.floor(vol / 1000) * 1000;
      const key = `${c[0]}-${lk}`;
      if (valerts.some(a => a.key === key)) return;

      const kt = new Date(t.getTime() + 9 * 3600000);
      const ts = `${kt.getUTCFullYear()}-${String(kt.getUTCMonth()+1).padStart(2,'0')}-${String(kt.getUTCDate()).padStart(2,'0')} ${String(kt.getUTCHours()).padStart(2,'0')}:${String(kt.getUTCMinutes()).padStart(2,'0')}`;
      const a  = { key, ts, vol, lk, pr };
      valerts.unshift(a);
      save();
      render();
      App.toast(`ğŸ”¥ ê±°ë˜ëŸ‰ ${fmt(Math.round(vol))} BTC`, `${ts} KST Â· $${fmt(pr)}`);
      beep(Math.min(Math.floor(lk / 1000), 5));
    } catch {}
  }

  function render() {
    const list  = document.getElementById('valList');
    const empty = document.getElementById('valEmpty');
    if (!valerts.length) {
      list.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';
    list.innerHTML = valerts.slice(0, 100).map(a => {
      const lv = Math.min(Math.floor(a.lk / 1000), 5);
      return `<div class="va">
        <div class="vb l${lv}">${fmt(a.lk)}+</div>
        <div class="vi">
          <div class="vt">${a.ts} KST</div>
          <div class="vp">${fmt(Math.round(a.vol))} BTC Â· $${fmt(Math.round(a.pr))}</div>
        </div>
      </div>`;
    }).join('');
  }

  function clear() { valerts = []; save(); render(); }
  function save()  { try { localStorage.setItem('btcva', JSON.stringify(valerts.slice(0, 300))); } catch {} }
  function load()  { try { const s = localStorage.getItem('btcva'); if (s) { valerts = JSON.parse(s); render(); } } catch {} }

  return { toggle, toggleSnd, clear, load };
})();


/* ---- crash.js ---- */
// ============================================================
// CRASH.JS â€” ê¸‰ë½ êµ¬ê°„ íƒì§€ (ê±°ë˜ëŸ‰ ë™ë°˜ ê¸‰ë½ ê°•í™”)
//
// 1) 12h / 24h / 3d ìœˆë„ìš° ë‚´ ê³ ì â†’ì €ì  ë‚™í­ íƒì§€
// 2) ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬ ë™ë°˜ ì—¬ë¶€ í‘œì‹œ (ìµœê·¼ 20ë´‰ í‰ê·  ëŒ€ë¹„ ë°°ìˆ˜)
// 3) ê±°ë˜ëŸ‰ ê¸‰ì¦ + ê¸‰ë½ = ê°•í•œ ì‹ í˜¸ë¡œ ê°•ì¡°
// ============================================================
const Crash = (() => {

  const WINDOWS = {
    '12h': { label: '12ì‹œê°„', hours: 12 },
    '24h': { label: '24ì‹œê°„', hours: 24 },
    '3d':  { label: '3ì¼',    hours: 72 },
  };

  let curWindow  = '24h';
  let threshold  = 10;
  let loading    = false;
  let cache4h    = [];

  const fmt  = n => Math.round(n).toLocaleString('en-US');
  const fmtP = n => n.toFixed(1);
  const $    = id => document.getElementById(id);

  async function loadCandles() {
    if (cache4h.length) return;
    const raw = await API.klines(Config.SYM, '4h', 1500);
    cache4h = raw.map(k => ({
      time: k[0], date: new Date(k[0]),
      open: +k[1], high: +k[2], low: +k[3], close: +k[4],
      volume: +k[5]
    }));
  }

  // ê±°ë˜ëŸ‰ ë°°ìˆ˜ ê³„ì‚° (í•´ë‹¹ ìº”ë“¤ vs ì§ì „ 20ë´‰ í‰ê· )
  function volMultiplier(candles, idx) {
    const lookback = 20;
    if (idx < lookback) return 1;
    let sum = 0;
    for (let j = idx - lookback; j < idx; j++) sum += candles[j].volume;
    const avg = sum / lookback;
    return avg > 0 ? candles[idx].volume / avg : 1;
  }

  function detectEvents(pct) {
    const hours    = WINDOWS[curWindow].hours;
    const candles  = cache4h;
    const lookback = Math.ceil(hours / 4);
    const MIN_GAP  = Math.max(lookback, 3);
    const events   = [];
    let lastEnd    = -999;

    for (let i = lookback; i < candles.length; i++) {
      let peakVal = -Infinity, peakIdx = i - lookback;
      for (let j = i - lookback; j < i; j++) {
        if (candles[j].high > peakVal) { peakVal = candles[j].high; peakIdx = j; }
      }

      const drawdown = (candles[i].low - peakVal) / peakVal * 100;
      if (drawdown > -pct) continue;

      // ê±°ë˜ëŸ‰ ë¶„ì„: ë‚™í­ êµ¬ê°„ ë‚´ ìµœëŒ€ ê±°ë˜ëŸ‰ ë´‰ì˜ ë°°ìˆ˜
      let maxVolMult = 0;
      let maxVolIdx  = i;
      for (let j = peakIdx; j <= i; j++) {
        const vm = volMultiplier(candles, j);
        if (vm > maxVolMult) { maxVolMult = vm; maxVolIdx = j; }
      }

      if (events.length && i - lastEnd < MIN_GAP) {
        const prev = events[events.length - 1];
        if (drawdown < prev.maxDrop) {
          prev.maxDrop     = drawdown;
          prev.troughDate  = candles[i].date;
          prev.troughPrice = candles[i].low;
          prev.troughTime  = candles[i].time;
        }
        if (maxVolMult > prev.volMult) prev.volMult = maxVolMult;
        prev.endIdx = i;
        lastEnd = i;
        continue;
      }

      events.push({
        peakDate:    candles[peakIdx].date,
        peakPrice:   peakVal,
        troughDate:  candles[i].date,
        troughPrice: candles[i].low,
        troughTime:  candles[i].time,
        maxDrop:     drawdown,
        endIdx:      i,
        durationH:   Math.round((candles[i].time - candles[peakIdx].time) / 3600000),
        volMult:     maxVolMult,
      });
      lastEnd = i;
    }

    // íšŒë³µ
    events.forEach(ev => {
      ev.recovered = false;
      for (let i = ev.endIdx + 1; i < candles.length; i++) {
        if (candles[i].high >= ev.peakPrice) {
          ev.recovered   = true;
          ev.recoverDate = candles[i].date;
          ev.recoverH    = Math.round((candles[i].time - ev.troughTime) / 3600000);
          break;
        }
      }
      if (!ev.recovered) ev.recoverH = Math.round((Date.now() - ev.troughTime) / 3600000);
    });

    return events.reverse();
  }

  function fmtDate(d)     { return `${d.getUTCFullYear()}.${String(d.getUTCMonth()+1).padStart(2,'0')}.${String(d.getUTCDate()).padStart(2,'0')}`; }
  function fmtDateTime(d) { return fmtDate(d) + ' ' + String(d.getUTCHours()).padStart(2,'0') + ':00'; }
  function fmtDuration(h) { return h < 24 ? h + 'ì‹œê°„' : (h % 24 ? `${Math.floor(h/24)}ì¼ ${h%24}ì‹œê°„` : `${h/24}ì¼`); }

  function render(events) {
    const list = $('crashList'), empty = $('crashEmpty');
    $('crashLoad').style.display = 'none';

    if (!events.length) {
      list.innerHTML = '';
      empty.style.display = 'block';
      empty.querySelector('.ei').textContent = 'âœ…';
      empty.querySelector('span').textContent = `${WINDOWS[curWindow].label} ë‚´ ${threshold}% ì´ìƒ ê¸‰ë½ ì—†ìŒ`;
      return;
    }

    empty.style.display = 'none';
    $('crashCount').textContent = `${events.length}ê±´`;

    list.innerHTML = events.map((ev, idx) => {
      const dropColor = ev.maxDrop <= -20 ? 'var(--red)' : ev.maxDrop <= -10 ? '#ed8936' : 'var(--amber)';

      // ê±°ë˜ëŸ‰ ì‹ í˜¸ ê°•ë„
      const volTag = ev.volMult >= 3
        ? `<span class="crash-vol-tag vol-high">ğŸ”¥ ê±°ë˜ëŸ‰ ${ev.volMult.toFixed(1)}Ã—</span>`
        : ev.volMult >= 2
        ? `<span class="crash-vol-tag vol-mid">âš¡ ê±°ë˜ëŸ‰ ${ev.volMult.toFixed(1)}Ã—</span>`
        : ev.volMult >= 1.5
        ? `<span class="crash-vol-tag vol-low">ğŸ“Š ê±°ë˜ëŸ‰ ${ev.volMult.toFixed(1)}Ã—</span>`
        : '';

      const strongSignal = ev.volMult >= 2 && ev.maxDrop <= -pctToStrong();

      const recoverTxt = ev.recovered
        ? `<span style="color:var(--green)">âœ“ ${fmtDuration(ev.recoverH)}ë§Œì— íšŒë³µ</span>`
        : `<span style="color:var(--dim)">ë¯¸íšŒë³µ (${fmtDuration(ev.recoverH)}ì§¸)</span>`;

      return `
      <div class="crash-card ${strongSignal ? 'strong-signal' : ''}">
        <div class="crash-header">
          <div class="crash-rank">#${idx+1}</div>
          <div class="crash-drop" style="color:${dropColor}">${fmtP(ev.maxDrop)}%</div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--dim);margin-left:4px">${fmtDuration(ev.durationH)}ê°„</div>
          ${volTag}
          <div class="crash-recover">${recoverTxt}</div>
        </div>
        <div class="crash-body">
          <div class="crash-row">
            <div class="crash-col">
              <div class="crash-label">ğŸ“ˆ ê³ ì </div>
              <div class="crash-date">${fmtDateTime(ev.peakDate)}</div>
              <div class="crash-price">$${fmt(ev.peakPrice)}</div>
            </div>
            <div class="crash-arrow">â–¼</div>
            <div class="crash-col">
              <div class="crash-label">ğŸ“‰ ì €ì </div>
              <div class="crash-date">${fmtDateTime(ev.troughDate)}</div>
              <div class="crash-price" style="color:${dropColor}">$${fmt(ev.troughPrice)}</div>
            </div>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  // "ê°•í•œ ì‹ í˜¸" ê¸°ì¤€: ìœˆë„ìš°ì— ë”°ë¼ ë‹¤ë¦„
  function pctToStrong() {
    if (curWindow === '12h') return 5;
    if (curWindow === '24h') return 8;
    return 12;
  }

  async function run() {
    if (loading) return;
    loading = true;
    $('crashLoad').style.display = 'block';
    $('crashList').innerHTML = '';
    $('crashEmpty').style.display = 'none';
    $('crashCount').textContent = '';
    try {
      await loadCandles();
      render(detectEvents(threshold));
    } catch(e) {
      $('crashLoad').style.display = 'none';
      $('crashList').innerHTML = `<div class="err">âš ï¸ ${e.message}</div>`;
    }
    loading = false;
  }

  function setWindow(w, btn) {
    curWindow = w;
    document.querySelectorAll('.crash-win-btn').forEach(b => b.classList.remove('on'));
    if (btn) btn.classList.add('on');
  }

  function setThreshold(val) {
    const v = parseFloat(val);
    if (isNaN(v) || v < 3 || v > 50) return;
    threshold = v;
    $('crashThreshVal').textContent = v + '%';
  }

  function bindControls() {
    const slider = $('crashSlider'), input = $('crashInput');
    if (!slider || !input) return;
    slider.addEventListener('input', () => { input.value = slider.value; setThreshold(slider.value); });
    input.addEventListener('change', () => {
      const v = Math.min(50, Math.max(3, parseFloat(input.value) || 10));
      input.value = v; slider.value = v; setThreshold(v);
    });
  }

  function init() { bindControls(); }

  return { init, run, setWindow };
})();


/* ---- funding.js ---- */
// ============================================================
// FUNDING.JS â€” ë°”ì´ë¹„íŠ¸ í€ë”©ë¹„ (ë‚ ì§œë²”ìœ„ + localStorage ì €ì¥)
// ============================================================
const Funding = (() => {

  let allRecords = [];
  let loading    = false;

  const LS_POS  = 'btc_fund_pos';
  const LS_FROM = 'btc_fund_from';
  const LS_TO   = 'btc_fund_to';

  const $    = id => document.getElementById(id);
  const fmtP = (n, d=4) => (n * 100).toFixed(d) + '%';
  const fmtD = d => `${d.getUTCFullYear()}.${String(d.getUTCMonth()+1).padStart(2,'0')}.${String(d.getUTCDate()).padStart(2,'0')}`;

  // â”€â”€ ì €ì¥/ë³µì› â”€â”€
  function saveSettings() {
    const pos  = $('fund-pos-size')?.value || '10000';
    const from = $('fund-from')?.value || '';
    const to   = $('fund-to')?.value || '';
    localStorage.setItem(LS_POS, pos);
    if (from) localStorage.setItem(LS_FROM, from); else localStorage.removeItem(LS_FROM);
    if (to)   localStorage.setItem(LS_TO, to);     else localStorage.removeItem(LS_TO);
  }

  function restoreSettings() {
    const pos  = localStorage.getItem(LS_POS) || '10000';
    const from = localStorage.getItem(LS_FROM) || '';
    const to   = localStorage.getItem(LS_TO) || '';
    if ($('fund-pos-size')) $('fund-pos-size').value = pos;
    if ($('fund-from'))     $('fund-from').value = from;
    if ($('fund-to'))       $('fund-to').value = to;
  }

  // â”€â”€ Bybit API â”€â”€
  async function fetchFunding(symbol, startTime, endTime, limit) {
    const params = new URLSearchParams({ category: 'linear', symbol: symbol || 'BTCUSDT', limit: limit || 200 });
    if (startTime) params.set('startTime', startTime);
    if (endTime)   params.set('endTime', endTime);
    const url = `https://api.bybit.com/v5/market/funding/history?${params}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('Bybit API ì˜¤ë¥˜: ' + r.status);
    const data = await r.json();
    if (data.retCode !== 0) throw new Error(data.retMsg || 'Bybit API ì˜¤ë¥˜');
    return data.result.list || [];
  }

  // â”€â”€ ì „ì²´ ë¡œë“œ (í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ìµœëŒ€ ~90ì¼) â”€â”€
  async function loadData() {
    const status = $('fund-status');
    if (status) status.textContent = 'ë°”ì´ë¹„íŠ¸ í€ë”©ë¹„ ë¡œë”© ì¤‘â€¦';

    try {
      let all = [];
      let cursor = null;
      const maxPages = 4; // 200Ã—4 = 800ê±´ â‰ˆ 266ì¼

      for (let page = 0; page < maxPages; page++) {
        const raw = await fetchFunding('BTCUSDT', null, cursor, 200);
        if (!raw.length) break;

        all = all.concat(raw);
        // BybitëŠ” ìµœì‹ â†’ê³¼ê±°ìˆœ ë°˜í™˜, ë§ˆì§€ë§‰ í•­ëª©ì˜ timestamp - 1
        const lastTs = +raw[raw.length - 1].fundingRateTimestamp;
        cursor = lastTs - 1;

        if (status) status.textContent = `ë¡œë”© ì¤‘â€¦ ${all.length}ê±´`;
        if (raw.length < 200) break;
        await new Promise(r => setTimeout(r, 200));
      }

      allRecords = all.map(r => ({
        time: new Date(+r.fundingRateTimestamp),
        rate: parseFloat(r.fundingRate),
      })).sort((a, b) => a.time - b.time);

      if (status) status.textContent = `${allRecords.length}ê±´ ë¡œë“œ (${fmtD(allRecords[0].time)} ~ ${fmtD(allRecords[allRecords.length-1].time)})`;
      render();
    } catch(e) {
      if (status) status.textContent = 'ì˜¤ë¥˜: ' + e.message;
    }
  }

  // â”€â”€ ë‚ ì§œ í•„í„°ë§ â”€â”€
  function getFilteredRecords() {
    const fromVal = $('fund-from')?.value;
    const toVal   = $('fund-to')?.value;

    let filtered = allRecords;
    if (fromVal) {
      const from = new Date(fromVal + 'T00:00:00Z');
      filtered = filtered.filter(r => r.time >= from);
    }
    if (toVal) {
      const to = new Date(toVal + 'T23:59:59Z');
      filtered = filtered.filter(r => r.time <= to);
    }
    return filtered;
  }

  // â”€â”€ ì¼ë³„ ê·¸ë£¹í•‘ â”€â”€
  function groupByDay(records) {
    const map = new Map();
    records.forEach(r => {
      const key = fmtD(r.time);
      if (!map.has(key)) map.set(key, { date: key, items: [], sum: 0 });
      const g = map.get(key);
      g.items.push(r);
      g.sum += r.rate;
    });
    return Array.from(map.values()).reverse();
  }

  // â”€â”€ ë Œë”ë§ â”€â”€
  function render() {
    const list    = $('fund-list');
    const summary = $('fund-summary');
    if (!list || !allRecords.length) return;

    saveSettings();

    const filtered = getFilteredRecords();
    const posSize  = parseFloat($('fund-pos-size')?.value) || 10000;

    // ì „ì²´ í†µê³„ (í•„í„° ë¬´ê´€)
    const last7d  = allRecords.filter(r => r.time >= new Date(Date.now() - 7  * 864e5));
    const last30d = allRecords.filter(r => r.time >= new Date(Date.now() - 30 * 864e5));
    const avg7d   = last7d.length  ? last7d.reduce((s, r) => s + r.rate, 0) / last7d.length : 0;
    const avg30d  = last30d.length ? last30d.reduce((s, r) => s + r.rate, 0) / last30d.length : 0;
    const current = allRecords[allRecords.length - 1];

    // ì„ íƒ êµ¬ê°„ í•©ì‚°
    const rangeSum   = filtered.reduce((s, r) => s + r.rate, 0);
    const rangeDays  = filtered.length ? Math.ceil((filtered[filtered.length-1].time - filtered[0].time) / 864e5) : 0;
    const rangeCost  = Math.abs(rangeSum * posSize);

    const rateColor = v => v >= 0 ? 'var(--green)' : 'var(--red)';

    if (summary) {
      summary.innerHTML = `
        <div class="fund-stats">
          <div class="fund-stat">
            <div class="fund-stat-label">í˜„ì¬ í€ë”©ë¹„</div>
            <div class="fund-stat-val" style="color:${rateColor(current.rate)}">${fmtP(current.rate)}</div>
            <div class="fund-stat-sub">${current.time.getUTCHours()}:00 UTC</div>
          </div>
          <div class="fund-stat">
            <div class="fund-stat-label">7ì¼ í‰ê· </div>
            <div class="fund-stat-val" style="color:${rateColor(avg7d)}">${fmtP(avg7d)}</div>
            <div class="fund-stat-sub">${last7d.length}ê±´</div>
          </div>
          <div class="fund-stat">
            <div class="fund-stat-label">30ì¼ í‰ê· </div>
            <div class="fund-stat-val" style="color:${rateColor(avg30d)}">${fmtP(avg30d)}</div>
            <div class="fund-stat-sub">${last30d.length}ê±´</div>
          </div>
          <div class="fund-stat highlight">
            <div class="fund-stat-label">ì„ íƒ êµ¬ê°„ í•©ê³„</div>
            <div class="fund-stat-val" style="color:${rateColor(rangeSum)}">${fmtP(rangeSum, 3)}</div>
            <div class="fund-stat-sub">${filtered.length}ê±´ Â· ${rangeDays}ì¼ Â· <b style="color:${rateColor(rangeSum)}">$${rangeCost.toFixed(0)}</b></div>
          </div>
        </div>

        <div class="fund-cost-box">
          <div class="fund-cost-title">ğŸ’µ í¬ì§€ì…˜ $${posSize.toLocaleString()} ê¸°ì¤€ ì˜ˆìƒ í€ë”© ë¹„ìš©</div>
          <div class="fund-cost-grid">
            <div><span class="fund-cost-label">ì¼ì¼ (3íšŒ)</span><span class="fund-cost-val" style="color:${rateColor(avg30d)}">$${Math.abs(avg30d * 3 * posSize).toFixed(2)}</span></div>
            <div><span class="fund-cost-label">ì£¼ê°„</span><span class="fund-cost-val" style="color:${rateColor(avg30d)}">$${Math.abs(avg30d * 21 * posSize).toFixed(2)}</span></div>
            <div><span class="fund-cost-label">ì›”ê°„</span><span class="fund-cost-val" style="color:${rateColor(avg30d)}">$${Math.abs(avg30d * 90 * posSize).toFixed(2)}</span></div>
            <div><span class="fund-cost-label">ì„ íƒêµ¬ê°„</span><span class="fund-cost-val" style="color:${rateColor(rangeSum)}"><b>$${rangeCost.toFixed(2)}</b></span></div>
          </div>
        </div>
      `;
    }

    // ì¼ë³„ ìƒì„¸
    const daily = groupByDay(filtered);
    list.innerHTML = daily.slice(0, 90).map(day => {
      const dayColor = day.sum >= 0 ? 'var(--green)' : 'var(--red)';
      const dayCost  = Math.abs(day.sum * posSize);
      const items = day.items.map(r => {
        const rc = r.rate >= 0 ? 'var(--green)' : 'var(--red)';
        const h = String(r.time.getUTCHours()).padStart(2, '0') + ':00';
        return `<span class="fund-item" style="color:${rc}">${h} ${fmtP(r.rate)}</span>`;
      }).join('');

      return `
      <div class="fund-day">
        <div class="fund-day-head">
          <span class="fund-day-date">${day.date}</span>
          <span class="fund-day-sum" style="color:${dayColor}">ì¼ê³„ ${fmtP(day.sum, 3)}</span>
          <span class="fund-day-cost" style="color:${dayColor}">$${dayCost.toFixed(0)}</span>
        </div>
        <div class="fund-day-items">${items}</div>
      </div>`;
    }).join('');
  }

  async function init() {
    restoreSettings();
    await loadData();
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    ['fund-pos-size', 'fund-from', 'fund-to'].forEach(id => {
      const el = $(id);
      if (el) el.addEventListener('change', render);
      if (el && id === 'fund-pos-size') el.addEventListener('input', render);
    });
  }

  return { init, render };
})();


/* ---- heatmap.js ---- */
// ============================================================
// HEATMAP.JS â€” BTC ì›”ë³„ ìˆ˜ìµë¥  íˆíŠ¸ë§µ (Coinglass ìŠ¤íƒ€ì¼)
//
// Binance ì›”ë´‰ ë°ì´í„°ë¡œ ì›”ë³„ ì‹œê°€â†’ì¢…ê°€ ìˆ˜ìµë¥  ê³„ì‚°
// ì—°ë„ë³„ Ã— ì›”ë³„ íˆíŠ¸ë§µ + ì—°ê°„/ì›”í‰ê·  í‘œì‹œ
// ============================================================
const Heatmap = (() => {

  let loaded = false;
  const $ = id => document.getElementById(id);

  async function load() {
    if (loaded) return;
    const status = $('hm-status');
    if (status) status.textContent = 'ë°ì´í„° ë¡œë”© ì¤‘â€¦';

    try {
      // ì›”ë´‰ ë°ì´í„° (ìµœëŒ€ 200ê°œ = ~16ë…„)
      const raw = await API.klines(Config.SYM, '1M', 200);
      const monthly = raw.map(k => ({
        openTime: k[0],
        open:  +k[1],
        high:  +k[2],
        low:   +k[3],
        close: +k[4],
        date:  new Date(k[0]),
      }));

      // ì—°ë„-ì›” ë§¤í•‘
      const data = {};   // { 2020: { 1: pct, 2: pct, ... }, ... }
      const years = new Set();

      monthly.forEach(m => {
        const y = m.date.getUTCFullYear();
        const mo = m.date.getUTCMonth() + 1; // 1~12
        const pct = ((m.close - m.open) / m.open) * 100;
        years.add(y);
        if (!data[y]) data[y] = {};
        data[y][mo] = pct;
      });

      // ì—°ê°„ ìˆ˜ìµë¥  (1ì›” ì‹œê°€ â†’ 12ì›” ì¢…ê°€ or ë§ˆì§€ë§‰ ì›” ì¢…ê°€)
      const yearList = Array.from(years).sort((a, b) => b - a); // ìµœì‹ ìˆœ

      // ì›”ë³„ í‰ê· /ì¤‘ì•™ê°’
      const monthAvg = {}, monthMed = {};
      for (let mo = 1; mo <= 12; mo++) {
        const vals = yearList.map(y => data[y]?.[mo]).filter(v => v !== undefined);
        monthAvg[mo] = vals.length ? vals.reduce((s, v) => s + v, 0) / vals.length : null;
        if (vals.length) {
          const sorted = [...vals].sort((a, b) => a - b);
          monthMed[mo] = sorted[Math.floor(sorted.length / 2)];
        }
      }

      // ì—°ê°„ ìˆ˜ìµë¥ 
      const yearReturn = {};
      yearList.forEach(y => {
        const months = Object.values(data[y]);
        if (!months.length) return;
        // ë³µë¦¬ ê³„ì‚°
        let compound = 1;
        months.forEach(p => compound *= (1 + p / 100));
        yearReturn[y] = (compound - 1) * 100;
      });

      render(yearList, data, monthAvg, monthMed, yearReturn);
      if (status) status.textContent = '';
      loaded = true;
    } catch(e) {
      if (status) status.textContent = 'ì˜¤ë¥˜: ' + e.message;
    }
  }

  function cellColor(pct) {
    if (pct === undefined || pct === null) return { bg: 'transparent', text: 'var(--dim)' };
    // ê°•ë„ ë§¤í•‘: -30% ~ +30% ë²”ìœ„
    const clamped = Math.max(-30, Math.min(30, pct));
    const ratio = clamped / 30; // -1 ~ 1

    if (ratio >= 0) {
      // ì´ˆë¡ ê³„ì—´
      const a = 0.08 + ratio * 0.55;
      return { bg: `rgba(45,184,126,${a.toFixed(2)})`, text: ratio > 0.3 ? '#fff' : 'var(--green)' };
    } else {
      const a = 0.08 + Math.abs(ratio) * 0.55;
      return { bg: `rgba(231,76,90,${a.toFixed(2)})`, text: Math.abs(ratio) > 0.3 ? '#fff' : 'var(--red)' };
    }
  }

  function fmtP(v) {
    if (v === undefined || v === null) return '';
    const sign = v >= 0 ? '+' : '';
    return sign + v.toFixed(2) + '%';
  }

  function render(yearList, data, monthAvg, monthMed, yearReturn) {
    const el = $('hm-table');
    if (!el) return;

    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    let html = '<div class="hm-scroll"><table class="hm-grid">';

    // í—¤ë”
    html += '<thead><tr><th class="hm-corner">Year</th>';
    months.forEach(m => html += `<th>${m}</th>`);
    html += '<th class="hm-yr">ì—°ê°„</th></tr></thead><tbody>';

    // ì—°ë„ í–‰
    yearList.forEach(y => {
      html += `<tr><td class="hm-year">${y}</td>`;
      for (let mo = 1; mo <= 12; mo++) {
        const val = data[y]?.[mo];
        const c = cellColor(val);
        html += `<td class="hm-cell" style="background:${c.bg};color:${c.text}">${fmtP(val)}</td>`;
      }
      // ì—°ê°„
      const yr = yearReturn[y];
      const yc = cellColor(yr);
      html += `<td class="hm-cell hm-yr-cell" style="background:${yc.bg};color:${yc.text}">${fmtP(yr)}</td>`;
      html += '</tr>';
    });

    // í‰ê·  í–‰
    html += '<tr class="hm-summary"><td class="hm-year">Average</td>';
    for (let mo = 1; mo <= 12; mo++) {
      const c = cellColor(monthAvg[mo]);
      html += `<td class="hm-cell" style="background:${c.bg};color:${c.text}">${fmtP(monthAvg[mo])}</td>`;
    }
    html += '<td class="hm-cell"></td></tr>';

    // ì¤‘ì•™ê°’ í–‰
    html += '<tr class="hm-summary"><td class="hm-year">Median</td>';
    for (let mo = 1; mo <= 12; mo++) {
      const c = cellColor(monthMed[mo]);
      html += `<td class="hm-cell" style="background:${c.bg};color:${c.text}">${fmtP(monthMed[mo])}</td>`;
    }
    html += '<td class="hm-cell"></td></tr>';

    html += '</tbody></table></div>';

    // ë²”ë¡€
    html += `<div class="hm-legend">
      <span class="hm-leg-item"><span class="hm-leg-box" style="background:rgba(231,76,90,.55)"></span>-30%â†“</span>
      <span class="hm-leg-item"><span class="hm-leg-box" style="background:rgba(231,76,90,.2)"></span>-10%</span>
      <span class="hm-leg-item"><span class="hm-leg-box" style="background:rgba(107,114,128,.1)"></span>0%</span>
      <span class="hm-leg-item"><span class="hm-leg-box" style="background:rgba(45,184,126,.2)"></span>+10%</span>
      <span class="hm-leg-item"><span class="hm-leg-box" style="background:rgba(45,184,126,.55)"></span>+30%â†‘</span>
    </div>`;

    el.innerHTML = html;
  }

  return { load };
})();


/* ---- signal.js ---- */
// ============================================================
// SIGNAL.JS â€” HMA ë“€ì–¼ í¬ë¡œìŠ¤ ë§¤ë§¤ ì‹ í˜¸ (Entry/SL/TP)
//
// HMA 60 (ë‹¨ê¸°, ì´ˆë¡) + HMA 200 (ì¥ê¸°, ë¹¨ê°•) on 15ë¶„ë´‰
// ê³¨ë“ í¬ë¡œìŠ¤ â†’ Long, ë°ë“œí¬ë¡œìŠ¤ â†’ Short
// SL = ATR(14) on 15m, TP = 0.5Ã—/1.667Ã—/2.5Ã—/3.333Ã—/5.0Ã— SL
// ============================================================
const Signal = (() => {

  const LS_KEY  = 'btc_signals';
  const TP_MULT = [0.5, 1.667, 2.5, 3.333, 5.0];
  const HMA_SHORT = 60;
  const HMA_LONG  = 200;
  const ATR_PERIOD = 14;

  let signals   = [];
  let lastCheck = 0;
  let monitorOn = false;
  let monitorIv = null;

  const $    = id => document.getElementById(id);
  const fmt  = n => Math.round(n).toLocaleString('en-US');
  const fmtP = n => n.toFixed(1);

  // â”€â”€ RSI ê³„ì‚° (ì‹ í˜¸ íƒ­ìš©) â”€â”€
  function calcRSI(closes, period = 14) {
    if (closes.length < period + 1) return [];
    const rsi = new Array(closes.length).fill(null);
    let avgGain = 0, avgLoss = 0;

    for (let i = 1; i <= period; i++) {
      const diff = closes[i] - closes[i - 1];
      if (diff > 0) avgGain += diff; else avgLoss -= diff;
    }
    avgGain /= period;
    avgLoss /= period;

    rsi[period] = avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));

    for (let i = period + 1; i < closes.length; i++) {
      const diff = closes[i] - closes[i - 1];
      const gain = diff > 0 ? diff : 0;
      const loss = diff < 0 ? -diff : 0;
      avgGain = (avgGain * (period - 1) + gain) / period;
      avgLoss = (avgLoss * (period - 1) + loss) / period;
      rsi[i] = avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));
    }
    return rsi;
  }

  // â”€â”€ ATR(14) on 15m candles â”€â”€
  function calcATR15m(candles, period = ATR_PERIOD) {
    const tr = candles.map((c, i) => {
      if (i === 0) return c.high - c.low;
      const prev = candles[i - 1];
      return Math.max(c.high - c.low, Math.abs(c.high - prev.close), Math.abs(c.low - prev.close));
    });
    // ë§ˆì§€ë§‰ period ê°œì˜ í‰ê· 
    const start = Math.max(0, tr.length - period);
    let sum = 0;
    for (let i = start; i < tr.length; i++) sum += tr[i];
    return sum / Math.min(period, tr.length - start);
  }

  // â”€â”€ í¬ë¡œìŠ¤ ê°ì§€ â”€â”€
  function detectCrosses(candles) {
    if (candles.length < HMA_LONG + 20) return [];

    const hmaShort = HMA.fromCandles(candles, HMA_SHORT);
    const hmaLong  = HMA.fromCandles(candles, HMA_LONG);

    // ì‹œê°„ ê¸°ì¤€ ë§¤í•‘
    const shortMap = new Map(hmaShort.map(h => [h.time, h.value]));
    const longMap  = new Map(hmaLong.map(h => [h.time, h.value]));

    // ê³µí†µ ì‹œê°„ëŒ€ë§Œ ì¶”ì¶œ
    const times = hmaLong.map(h => h.time).filter(t => shortMap.has(t));
    if (times.length < 3) return [];

    const crosses = [];
    for (let i = 1; i < times.length; i++) {
      const t = times[i], pt = times[i - 1];
      const sNow = shortMap.get(t), sP = shortMap.get(pt);
      const lNow = longMap.get(t),  lP = longMap.get(pt);
      if (sNow == null || sP == null || lNow == null || lP == null) continue;

      const prevDiff = sP - lP;
      const currDiff = sNow - lNow;

      if (prevDiff <= 0 && currDiff > 0) {
        crosses.push({ time: t, type: 'golden', price: sNow, hmaShort: sNow, hmaLong: lNow });
      } else if (prevDiff >= 0 && currDiff < 0) {
        crosses.push({ time: t, type: 'dead', price: sNow, hmaShort: sNow, hmaLong: lNow });
      }
    }
    return crosses;
  }

  // â”€â”€ ì‹ í˜¸ ìƒì„± â”€â”€
  function generateSignal(cross, candles) {
    const atr = calcATR15m(candles);
    const slDist = Math.round(atr);

    const isLong = cross.type === 'golden';
    const entry  = Math.round(cross.price);
    const sl     = isLong ? entry - slDist : entry + slDist;
    const tps    = TP_MULT.map(m => Math.round(isLong ? entry + slDist * m : entry - slDist * m));

    // í¬ë¡œìŠ¤ ì‹œì  ìº”ë“¤ì˜ RSI
    const closes = candles.map(c => c.close);
    const rsiArr = calcRSI(closes);
    const rsi = rsiArr[rsiArr.length - 1];

    return {
      id:        Date.now(),
      time:      cross.time,
      type:      isLong ? 'long' : 'short',
      crossType: cross.type,
      entry, sl, slDist,
      tp: tps,
      hmaShort:  Math.round(cross.hmaShort),
      hmaLong:   Math.round(cross.hmaLong),
      rsi:       rsi ? rsi.toFixed(1) : '-',
      status:    'active',
      hitTp:     [],
      hitSl:     false,
      created:   new Date().toISOString(),
    };
  }

  // â”€â”€ ì‹ í˜¸ ìƒíƒœ ì—…ë°ì´íŠ¸ â”€â”€
  async function updateStatuses() {
    if (!signals.length) return;
    try {
      const price = await API.tickerPrice(Config.SYM);
      signals.forEach(sig => {
        if (sig.status !== 'active') return;
        // SL ì²´í¬
        if (sig.type === 'long' && price <= sig.sl) {
          sig.status = 'stopped'; sig.hitSl = true;
        } else if (sig.type === 'short' && price >= sig.sl) {
          sig.status = 'stopped'; sig.hitSl = true;
        }
        // TP ì²´í¬
        sig.tp.forEach((tp, i) => {
          if (sig.hitTp.includes(i)) return;
          if (sig.type === 'long' && price >= tp) sig.hitTp.push(i);
          if (sig.type === 'short' && price <= tp) sig.hitTp.push(i);
        });
        if (sig.hitTp.length === 5) sig.status = 'completed';
      });
      save();
    } catch {}
  }

  // â”€â”€ ëª¨ë‹ˆí„°ë§ â”€â”€
  async function check() {
    if (!monitorOn) return;
    try {
      const raw = await API.klines(Config.SYM, '15m', 500);
      const candles = raw.map(k => ({
        time: k[0] / 1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4]
      }));

      const crosses = detectCrosses(candles);
      if (!crosses.length) return;

      const latest = crosses[crosses.length - 1];
      // ì¤‘ë³µ ë°©ì§€: ë§ˆì§€ë§‰ ì‹ í˜¸ì™€ ê°™ì€ ì‹œê°„ì´ë©´ ìŠ¤í‚µ
      if (signals.length && signals[0].time === latest.time) return;
      // ì´ë¯¸ ê°™ì€ íƒ€ì…ì˜ í¬ë¡œìŠ¤ê°€ ìµœê·¼ì— ìˆìœ¼ë©´ ìŠ¤í‚µ
      if (signals.length && signals[0].crossType === latest.type &&
          latest.time - signals[0].time < 3600) return;

      const sig = generateSignal(latest, candles);
      signals.unshift(sig);
      if (signals.length > 50) signals = signals.slice(0, 50);
      save();
      render();

      const dir = sig.type === 'long' ? 'ğŸŸ¢ LONG' : 'ğŸ”´ SHORT';
      App.toast(`ğŸ“Š ${dir} ì‹ í˜¸`, `Entry $${fmt(sig.entry)} / SL $${fmt(sig.sl)}`);
    } catch (e) {
      console.warn('Signal check error:', e);
    }
  }

  function toggleMonitor() {
    monitorOn = !monitorOn;
    const btn = $('sig-mon-btn');
    if (btn) {
      btn.textContent = monitorOn ? 'ğŸ”´ ëª¨ë‹ˆí„°ë§ ì¤‘' : 'â–¶ï¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘';
      btn.classList.toggle('on', monitorOn);
    }
    if (monitorOn) {
      check();
      monitorIv = setInterval(() => { check(); updateStatuses(); }, 60000);
    } else {
      if (monitorIv) clearInterval(monitorIv);
    }
  }

  // â”€â”€ ìˆ˜ë™ ìŠ¤ìº” â”€â”€
  async function scan() {
    const status = $('sig-status');
    if (status) status.textContent = 'ìŠ¤ìº” ì¤‘â€¦';
    try {
      const raw = await API.klines(Config.SYM, '15m', 500);
      const candles = raw.map(k => ({
        time: k[0] / 1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4]
      }));

      const crosses = detectCrosses(candles);
      if (!crosses.length) {
        if (status) status.textContent = 'ìµœê·¼ í¬ë¡œìŠ¤ ì—†ìŒ';
        render();
        return;
      }

      // ìµœê·¼ í¬ë¡œìŠ¤ë“¤ (ì¤‘ë³µ ì œê±° í›„ ìµœëŒ€ 5ê°œ)
      const existingTimes = new Set(signals.map(s => s.time));
      let added = 0;
      for (let i = crosses.length - 1; i >= Math.max(0, crosses.length - 5); i--) {
        const c = crosses[i];
        if (existingTimes.has(c.time)) continue;
        const sig = generateSignal(c, candles);
        signals.unshift(sig);
        added++;
      }
      signals.sort((a, b) => b.time - a.time);
      if (signals.length > 50) signals = signals.slice(0, 50);
      save();

      if (status) status.textContent = added > 0 ? `${added}ê°œ ì‹ í˜¸ ë°œê²¬` : 'ìƒˆ ì‹ í˜¸ ì—†ìŒ';
      render();
    } catch (e) {
      if (status) status.textContent = 'ì˜¤ë¥˜: ' + e.message;
    }
  }

  // â”€â”€ í˜„ì¬ HMA ìƒíƒœ â”€â”€
  async function getCurrentStatus() {
    try {
      const raw = await API.klines(Config.SYM, '15m', 500);
      const candles = raw.map(k => ({
        time: k[0] / 1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4]
      }));
      const hmaS = HMA.fromCandles(candles, HMA_SHORT);
      const hmaL = HMA.fromCandles(candles, HMA_LONG);
      if (!hmaS.length || !hmaL.length) return null;
      const s = hmaS[hmaS.length - 1].value;
      const l = hmaL[hmaL.length - 1].value;
      const trend = s > l ? 'bullish' : 'bearish';
      const gap = Math.abs(s - l);
      const gapPct = (gap / l * 100).toFixed(3);
      return { short: s, long: l, trend, gap, gapPct };
    } catch { return null; }
  }

  // â”€â”€ ë Œë”ë§ â”€â”€
  function render() {
    const el = $('sig-list');
    if (!el) return;

    if (!signals.length) {
      el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--dim)">ì‹ í˜¸ ì—†ìŒ â€” ìŠ¤ìº” ë˜ëŠ” ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•˜ì„¸ìš”</div>';
      return;
    }

    el.innerHTML = signals.slice(0, 20).map((sig, idx) => {
      const isLong  = sig.type === 'long';
      const dirIcon = isLong ? 'ğŸŸ¢' : 'ğŸ”´';
      const dirText = isLong ? 'LONG' : 'SHORT';
      const dirColor = isLong ? 'var(--green)' : 'var(--red)';
      const crossText = sig.crossType === 'golden' ? 'ê³¨ë“ í¬ë¡œìŠ¤' : 'ë°ë“œí¬ë¡œìŠ¤';

      const dt = new Date(sig.time * 1000);
      const kst = new Date(dt.getTime() + 9 * 3600000);
      const timeStr = `${kst.getUTCMonth()+1}/${kst.getUTCDate()} ${String(kst.getUTCHours()).padStart(2,'0')}:${String(kst.getUTCMinutes()).padStart(2,'0')}`;

      const statusBadge = sig.status === 'active' ? '<span class="sig-badge active">ì§„í–‰ì¤‘</span>'
        : sig.status === 'stopped' ? '<span class="sig-badge stopped">SL ë„ë‹¬</span>'
        : '<span class="sig-badge completed">TP5 ë„ë‹¬</span>';

      let tpHtml = sig.tp.map((tp, i) => {
        const hit = sig.hitTp.includes(i);
        return `<span class="sig-tp ${hit ? 'hit' : ''}" style="color:${hit ? 'var(--green)' : 'var(--dim)'}">TP${i+1} ${fmt(tp)} ${hit ? 'âœ“' : ''}</span>`;
      }).join('');

      return `
      <div class="sig-card ${sig.status}">
        <div class="sig-card-head">
          <span style="color:${dirColor};font-weight:900;font-size:14px">${dirIcon} ${dirText}</span>
          <span class="sig-cross">${crossText}</span>
          ${statusBadge}
          <span class="sig-time">${timeStr} KST</span>
        </div>
        <div class="sig-card-body">
          <div class="sig-levels">
            <div class="sig-level entry"><span>Entry</span><span>$${fmt(sig.entry)}</span></div>
            <div class="sig-level sl"><span>SL</span><span>$${fmt(sig.sl)}</span></div>
            <div class="sig-level" style="color:var(--dim)"><span>ATR</span><span>$${sig.slDist}</span></div>
            <div class="sig-level" style="color:var(--dim)"><span>RSI</span><span>${sig.rsi}</span></div>
          </div>
          <div class="sig-tps">${tpHtml}</div>
        </div>
      </div>`;
    }).join('');
  }

  // â”€â”€ localStorage â”€â”€
  function save() {
    try { localStorage.setItem(LS_KEY, JSON.stringify(signals.slice(0, 50))); } catch {}
  }
  function load() {
    try {
      const s = localStorage.getItem(LS_KEY);
      if (s) signals = JSON.parse(s);
    } catch {}
  }
  function clear() { signals = []; save(); render(); }

  // â”€â”€ ì´ˆê¸°í™” â”€â”€
  async function init() {
    load();
    render();
    // í˜„ì¬ ìƒíƒœ í‘œì‹œ
    const st = await getCurrentStatus();
    const el = $('sig-current');
    if (el && st) {
      const tc = st.trend === 'bullish' ? 'var(--green)' : 'var(--red)';
      const ti = st.trend === 'bullish' ? 'ğŸ“ˆ' : 'ğŸ“‰';
      const tl = st.trend === 'bullish' ? 'ìƒìŠ¹ ì¶”ì„¸ (ë¡± ìš°ìœ„)' : 'í•˜ë½ ì¶”ì„¸ (ìˆ ìš°ìœ„)';
      el.innerHTML = `
      <div class="sig-status-card" style="border-color:${tc}">
        <div style="font-size:18px">${ti}</div>
        <div>
          <div style="color:${tc};font-weight:900;font-size:14px">${tl}</div>
          <div style="font-size:11px;color:var(--dim);margin-top:2px">
            HMA ${HMA_SHORT}: $${fmt(st.short)} Â· HMA ${HMA_LONG}: $${fmt(st.long)} Â· ê°­ ${st.gapPct}%
          </div>
        </div>
      </div>`;
    }
  }

  return { init, scan, toggleMonitor, clear, render, detectCrosses, calcRSI, calcATR15m,
           HMA_SHORT, HMA_LONG, getCurrentStatus };
})();


/* ---- short-signal.js ---- */
// ============================================================
// SHORT-SIGNAL.JS â€” ì¢…í•© ì‹œê·¸ë„ ëŒ€ì‹œë³´ë“œ
//
// 1) Fear & Greed Index (Alternative.me)
// 2) Open Interest (Binance Futures)
// 3) í€ë”©ë¹„ ì•Œë¦¼ ê¸°ì¤€ì„  (Bybit)
// 4) RSI ë‹¤ì´ë²„ì „ìŠ¤ (15m/1h/4h/12h/1d) â˜…NEW
// ============================================================
const ShortSignal = (() => {

  let loaded = false;
  let fngData = [], oiData = [], oiCurrent = null, fundCurrent = null;
  let rsiResults = {};

  const $ = id => document.getElementById(id);
  const fmt = n => Math.round(n).toLocaleString('en-US');
  const fmtP = (n, d=4) => (n * 100).toFixed(d) + '%';

  // â”€â”€ Fear & Greed Index â”€â”€
  async function loadFNG() {
    try {
      const r = await fetch('https://api.alternative.me/fng/?limit=30&format=json');
      const json = await r.json();
      fngData = (json.data || []).map(d => ({
        value: parseInt(d.value), label: d.value_classification,
        time: new Date(d.timestamp * 1000),
      }));
    } catch { fngData = []; }
  }

  // â”€â”€ Open Interest â”€â”€
  async function loadOI() {
    try {
      const r1 = await fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT');
      const cur = await r1.json();
      oiCurrent = { oi: parseFloat(cur.openInterest), time: new Date(cur.time) };
      const r2 = await fetch('https://fapi.binance.com/futures/data/openInterestHist?symbol=BTCUSDT&period=1h&limit=48');
      const hist = await r2.json();
      oiData = hist.map(d => ({
        oi: parseFloat(d.sumOpenInterest),
        oiValue: parseFloat(d.sumOpenInterestValue),
        time: new Date(d.timestamp),
      }));
    } catch { oiData = []; }
  }

  // â”€â”€ í€ë”©ë¹„ â”€â”€
  async function loadFunding() {
    try {
      const r = await fetch('https://api.bybit.com/v5/market/funding/history?category=linear&symbol=BTCUSDT&limit=10');
      const json = await r.json();
      const list = json.result?.list || [];
      if (list.length) {
        fundCurrent = { rate: parseFloat(list[0].fundingRate), time: new Date(+list[0].fundingRateTimestamp) };
        const recent = list.slice(0, 3).map(r => parseFloat(r.fundingRate));
        fundCurrent.avg3 = recent.reduce((s, v) => s + v, 0) / recent.length;
      }
    } catch {}
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RSI ê³„ì‚° + ë‹¤ì´ë²„ì „ìŠ¤ íƒì§€
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function calcRSI(closes, period = 14) {
    if (closes.length < period + 1) return [];
    const rsi = new Array(closes.length).fill(null);
    let avgGain = 0, avgLoss = 0;
    for (let i = 1; i <= period; i++) {
      const d = closes[i] - closes[i-1];
      if (d > 0) avgGain += d; else avgLoss -= d;
    }
    avgGain /= period; avgLoss /= period;
    rsi[period] = avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss);
    for (let i = period + 1; i < closes.length; i++) {
      const d = closes[i] - closes[i-1];
      avgGain = (avgGain * (period-1) + Math.max(d,0)) / period;
      avgLoss = (avgLoss * (period-1) + Math.max(-d,0)) / period;
      rsi[i] = avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss);
    }
    return rsi;
  }

  // ë¡œì»¬ ê·¹ê°’ ì°¾ê¸° (lookback ë´‰ ì´ë‚´ ìµœê³ /ìµœì €)
  function findPeaks(arr, lookback = 5) {
    const peaks = [], troughs = [];
    for (let i = lookback; i < arr.length - lookback; i++) {
      if (arr[i] == null) continue;
      let isPeak = true, isTrough = true;
      for (let j = i - lookback; j <= i + lookback; j++) {
        if (j === i || arr[j] == null) continue;
        if (arr[j] >= arr[i]) isPeak = false;
        if (arr[j] <= arr[i]) isTrough = false;
      }
      if (isPeak) peaks.push(i);
      if (isTrough) troughs.push(i);
    }
    return { peaks, troughs };
  }

  // ë‹¤ì´ë²„ì „ìŠ¤ íƒì§€
  function detectDivergence(closes, rsiArr, lookback) {
    const pricePeaks = findPeaks(closes, lookback);
    const rsiPeaks   = findPeaks(rsiArr, lookback);
    const divergences = [];

    // í•˜ë½ ë‹¤ì´ë²„ì „ìŠ¤ (Bearish): ê°€ê²© higher high + RSI lower high
    for (let i = 1; i < pricePeaks.peaks.length; i++) {
      const curr = pricePeaks.peaks[i], prev = pricePeaks.peaks[i-1];
      if (closes[curr] <= closes[prev]) continue;
      // ê°™ì€ êµ¬ê°„ì˜ RSI í”¼í¬ ì°¾ê¸°
      const rsiPrev = rsiPeaks.peaks.filter(r => Math.abs(r - prev) <= lookback * 2).sort((a, b) => rsiArr[b] - rsiArr[a])[0];
      const rsiCurr = rsiPeaks.peaks.filter(r => Math.abs(r - curr) <= lookback * 2).sort((a, b) => rsiArr[b] - rsiArr[a])[0];
      if (rsiPrev == null || rsiCurr == null) continue;
      if (rsiArr[rsiCurr] < rsiArr[rsiPrev]) {
        divergences.push({ type: 'bearish', idx: curr, priceA: closes[prev], priceB: closes[curr],
          rsiA: rsiArr[rsiPrev], rsiB: rsiArr[rsiCurr] });
      }
    }

    // ìƒìŠ¹ ë‹¤ì´ë²„ì „ìŠ¤ (Bullish): ê°€ê²© lower low + RSI higher low
    for (let i = 1; i < pricePeaks.troughs.length; i++) {
      const curr = pricePeaks.troughs[i], prev = pricePeaks.troughs[i-1];
      if (closes[curr] >= closes[prev]) continue;
      const rsiPrev = rsiPeaks.troughs.filter(r => Math.abs(r - prev) <= lookback * 2).sort((a, b) => rsiArr[a] - rsiArr[b])[0];
      const rsiCurr = rsiPeaks.troughs.filter(r => Math.abs(r - curr) <= lookback * 2).sort((a, b) => rsiArr[a] - rsiArr[b])[0];
      if (rsiPrev == null || rsiCurr == null) continue;
      if (rsiArr[rsiCurr] > rsiArr[rsiPrev]) {
        divergences.push({ type: 'bullish', idx: curr, priceA: closes[prev], priceB: closes[curr],
          rsiA: rsiArr[rsiPrev], rsiB: rsiArr[rsiCurr] });
      }
    }

    return divergences;
  }

  // ë©€í‹° íƒ€ì„í”„ë ˆì„ RSI ë¡œë“œ
  async function loadRSI() {
    const timeframes = [
      { tf: '15m', label: '15ë¶„', lookback: 5, limit: 200 },
      { tf: '1h',  label: '1ì‹œê°„', lookback: 5, limit: 200 },
      { tf: '4h',  label: '4ì‹œê°„', lookback: 4, limit: 150 },
      { tf: '12h', label: '12ì‹œê°„', lookback: 3, limit: 100 },
      { tf: '1d',  label: '1ì¼', lookback: 3, limit: 100 },
    ];

    for (const t of timeframes) {
      try {
        const raw = await API.klines(Config.SYM, t.tf, t.limit);
        const closes = raw.map(k => +k[4]);
        const highs  = raw.map(k => +k[2]);
        const lows   = raw.map(k => +k[3]);
        const rsiArr = calcRSI(closes);
        const currentRSI = rsiArr[rsiArr.length - 1];

        // ë‹¤ì´ë²„ì „ìŠ¤ (ìµœê·¼ 60ë´‰ ë²”ìœ„)
        const recentStart = Math.max(0, closes.length - 60);
        const recentCloses = closes.slice(recentStart);
        const recentRSI    = rsiArr.slice(recentStart);
        const divs = detectDivergence(recentCloses, recentRSI, t.lookback);

        // ìµœê·¼ ë‹¤ì´ë²„ì „ìŠ¤ë§Œ (ìµœì‹  20ë´‰ ì´ë‚´)
        const recent = divs.filter(d => d.idx >= recentCloses.length - 20);

        rsiResults[t.tf] = {
          label: t.label, rsi: currentRSI,
          divergences: recent,
          hasBullish: recent.some(d => d.type === 'bullish'),
          hasBearish: recent.some(d => d.type === 'bearish'),
          rsiHistory: rsiArr.filter(v => v != null).slice(-50),
        };
      } catch {
        rsiResults[t.tf] = { label: t.label, rsi: null, divergences: [], hasBullish: false, hasBearish: false };
      }
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ì¢…í•© ì‹ í˜¸ íŒë‹¨
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function assessSignal() {
    const signals = [];
    let shortScore = 0, longScore = 0;

    // Fear & Greed
    if (fngData.length) {
      const cur = fngData[0].value;
      if (cur >= 75)      { shortScore += 2; signals.push({ icon: 'ğŸ”´', text: 'ê·¹ë‹¨ì  íƒìš• (' + cur + ')', hint: 'ê³¼ì—´ â†’ ìˆ ìœ ë¦¬' }); }
      else if (cur >= 55) { shortScore += 1; signals.push({ icon: 'ğŸŸ¡', text: 'íƒìš• (' + cur + ')', hint: 'ì£¼ì˜ êµ¬ê°„' }); }
      else if (cur <= 25) { longScore  += 2; signals.push({ icon: 'ğŸŸ¢', text: 'ê·¹ë‹¨ì  ê³µí¬ (' + cur + ')', hint: 'ê³µí¬ ê·¹ëŒ€ â†’ ë¡± ê¸°íšŒ' }); }
      else if (cur <= 45) { longScore  += 1; signals.push({ icon: 'ğŸŸ¢', text: 'ê³µí¬ (' + cur + ')', hint: 'ë¡± ì§„ì… ê³ ë ¤' }); }
      else { signals.push({ icon: 'âšª', text: 'ì¤‘ë¦½ (' + cur + ')', hint: 'ê´€ë§' }); }
    }

    // OI
    if (oiData.length >= 24) {
      const now24 = oiData[oiData.length-1].oiValue, ago24 = oiData[Math.max(0,oiData.length-24)].oiValue;
      const change = ((now24 - ago24) / ago24) * 100;
      if (change > 10)      { shortScore += 2; signals.push({ icon: 'ğŸ”´', text: `OI 24h +${change.toFixed(1)}%`, hint: 'ê³¼ì—´/ë ˆë²„ë¦¬ì§€ ê¸‰ì¦' }); }
      else if (change > 5)  { shortScore += 1; signals.push({ icon: 'ğŸŸ¡', text: `OI 24h +${change.toFixed(1)}%`, hint: 'OI ì¦ê°€ ì£¼ì˜' }); }
      else if (change < -10){ longScore  += 2; signals.push({ icon: 'ğŸŸ¢', text: `OI 24h ${change.toFixed(1)}%`, hint: 'ì²­ì‚° í­í¬ â†’ ë¡± ê¸°íšŒ' }); }
      else if (change < -5) { longScore  += 1; signals.push({ icon: 'ğŸŸ¢', text: `OI 24h ${change.toFixed(1)}%`, hint: 'OI ê°ì†Œ' }); }
      else { signals.push({ icon: 'âšª', text: `OI 24h ${change >= 0 ? '+' : ''}${change.toFixed(1)}%`, hint: 'ì •ìƒ ë²”ìœ„' }); }
    }

    // í€ë”©ë¹„
    if (fundCurrent) {
      const rate = fundCurrent.rate, th = 0.0003;
      if (rate > th * 2)  { shortScore += 2; signals.push({ icon: 'ğŸ”´', text: `í€ë”©ë¹„ ${fmtP(rate)}`, hint: 'ë¡± ê³¼ë°€ â†’ ìˆ ìœ ë¦¬' }); }
      else if (rate > th)  { shortScore += 1; signals.push({ icon: 'ğŸŸ¡', text: `í€ë”©ë¹„ ${fmtP(rate)}`, hint: 'ë¡± ìš°ì„¸ ì£¼ì˜' }); }
      else if (rate < -th) { longScore  += 1; signals.push({ icon: 'ğŸŸ¢', text: `í€ë”©ë¹„ ${fmtP(rate)}`, hint: 'ìˆ ê³¼ë°€ â†’ ë¡± ìœ ë¦¬' }); }
      else { signals.push({ icon: 'âšª', text: `í€ë”©ë¹„ ${fmtP(rate)}`, hint: 'ì¤‘ë¦½' }); }
    }

    // RSI ë‹¤ì´ë²„ì „ìŠ¤ (ë©€í‹°TF ì¢…í•©)
    let bearishTFs = 0, bullishTFs = 0;
    Object.values(rsiResults).forEach(r => {
      if (r.hasBearish) bearishTFs++;
      if (r.hasBullish) bullishTFs++;
    });
    if (bearishTFs >= 3) { shortScore += 2; signals.push({ icon: 'ğŸ”´', text: `í•˜ë½ ë‹¤ì´ë²„ì „ìŠ¤ ${bearishTFs}ê°œ TF`, hint: 'ë©€í‹°TF í•˜ë½ ì‹ í˜¸' }); }
    else if (bearishTFs >= 1) { shortScore += 1; signals.push({ icon: 'ğŸŸ¡', text: `í•˜ë½ ë‹¤ì´ë²„ì „ìŠ¤ ${bearishTFs}ê°œ TF`, hint: 'ë‹¨ê¸° í•˜ë½ ê²½ê³ ' }); }
    if (bullishTFs >= 3) { longScore += 2; signals.push({ icon: 'ğŸŸ¢', text: `ìƒìŠ¹ ë‹¤ì´ë²„ì „ìŠ¤ ${bullishTFs}ê°œ TF`, hint: 'ë©€í‹°TF ìƒìŠ¹ ì‹ í˜¸' }); }
    else if (bullishTFs >= 1) { longScore += 1; signals.push({ icon: 'ğŸŸ¢', text: `ìƒìŠ¹ ë‹¤ì´ë²„ì „ìŠ¤ ${bullishTFs}ê°œ TF`, hint: 'ë‹¨ê¸° ë°˜ë“± ê°€ëŠ¥' }); }

    return { signals, shortScore, longScore };
  }

  // â”€â”€ FNG ê²Œì´ì§€ â”€â”€
  function fngGauge(value) {
    let color;
    if (value <= 25) color = '#ef4444'; else if (value <= 45) color = '#f97316';
    else if (value <= 55) color = '#eab308'; else if (value <= 75) color = '#84cc16'; else color = '#22c55e';
    return `<svg viewBox="0 0 200 120" class="fng-gauge">
      <path d="M20,100 A80,80 0 0,1 180,100" fill="none" stroke="var(--border)" stroke-width="12" stroke-linecap="round"/>
      <path d="M20,100 A80,80 0 0,1 180,100" fill="none" stroke="url(#fng-grad)" stroke-width="12" stroke-linecap="round" stroke-dasharray="${(value/100)*251} 251"/>
      <defs><linearGradient id="fng-grad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stop-color="#ef4444"/><stop offset="25%" stop-color="#f97316"/>
        <stop offset="50%" stop-color="#eab308"/><stop offset="75%" stop-color="#84cc16"/>
        <stop offset="100%" stop-color="#22c55e"/></linearGradient></defs>
      <text x="100" y="88" text-anchor="middle" font-size="32" font-weight="900" fill="${color}" font-family="var(--mono)">${value}</text>
      <text x="100" y="108" text-anchor="middle" font-size="11" fill="var(--dim)">Fear & Greed</text>
      <text x="20" y="115" text-anchor="start" font-size="9" fill="var(--red)">ê³µí¬</text>
      <text x="180" y="115" text-anchor="end" font-size="9" fill="var(--green)">íƒìš•</text></svg>`;
  }

  // â”€â”€ OI ë¯¸ë‹ˆ ì°¨íŠ¸ â”€â”€
  function oiChart() {
    if (oiData.length < 2) return '';
    const vals = oiData.map(d => d.oiValue);
    const min = Math.min(...vals), max = Math.max(...vals), range = max - min || 1;
    const w = 100 / vals.length;
    let bars = vals.map((v, i) => {
      const h = 5 + ((v - min) / range) * 45;
      const color = i > 0 && v >= vals[i-1] ? 'rgba(45,184,126,.5)' : 'rgba(231,76,90,.5)';
      return `<rect x="${i*w}%" y="${50-h}" width="${Math.max(w-.3,.5)}%" height="${h}" fill="${color}" rx="1"/>`;
    }).join('');
    return `<svg viewBox="0 0 100 55" class="oi-chart" preserveAspectRatio="none">${bars}</svg>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ë Œë”ë§
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function render() {
    const el = $('ss-content');
    if (!el) return;
    const { signals, shortScore, longScore } = assessSignal();

    let verdict, verdictColor, verdictIcon;
    if (shortScore >= 4) { verdict = 'ìˆ ê°•í•œ ì‹ í˜¸'; verdictColor = 'var(--red)'; verdictIcon = 'ğŸ”»ğŸ”»'; }
    else if (shortScore >= 2 && shortScore > longScore) { verdict = 'ìˆ ì£¼ì˜ ì‹ í˜¸'; verdictColor = '#ed8936'; verdictIcon = 'ğŸ”»'; }
    else if (longScore >= 4) { verdict = 'ë¡± ê°•í•œ ê¸°íšŒ'; verdictColor = 'var(--green)'; verdictIcon = 'ğŸ”ºğŸ”º'; }
    else if (longScore >= 2 && longScore > shortScore) { verdict = 'ë¡± ê¸°íšŒ ê°ì§€'; verdictColor = 'var(--green)'; verdictIcon = 'ğŸ”º'; }
    else { verdict = 'ì¤‘ë¦½ / ê´€ë§'; verdictColor = 'var(--dim)'; verdictIcon = 'â–'; }

    let html = `
    <div class="ss-verdict" style="border-color:${verdictColor}">
      <div class="ss-verdict-icon">${verdictIcon}</div>
      <div class="ss-verdict-text" style="color:${verdictColor}">${verdict}</div>
      <div class="ss-verdict-score">
        <span style="color:var(--red)">ìˆ ${shortScore}</span> / <span style="color:var(--green)">ë¡± ${longScore}</span>
      </div>
    </div>`;

    // ì‹ í˜¸ ëª©ë¡
    html += '<div class="ss-signals">';
    signals.forEach(s => {
      html += `<div class="ss-sig-row"><span class="ss-sig-icon">${s.icon}</span>
        <span class="ss-sig-text">${s.text}</span><span class="ss-sig-hint">${s.hint}</span></div>`;
    });
    html += '</div>';

    // â•â•â• RSI ë‹¤ì´ë²„ì „ìŠ¤ ì„¹ì…˜ â•â•â•
    html += '<div class="ss-section"><div class="ss-section-title">ğŸ“Š RSI ë‹¤ì´ë²„ì „ìŠ¤ (ë©€í‹° íƒ€ì„í”„ë ˆì„)</div>';
    const tfOrder = ['15m','1h','4h','12h','1d'];
    html += '<div class="rsi-grid">';
    tfOrder.forEach(tf => {
      const r = rsiResults[tf];
      if (!r) return;
      const rsiVal = r.rsi != null ? r.rsi.toFixed(1) : '-';
      const rsiColor = r.rsi >= 70 ? 'var(--red)' : r.rsi <= 30 ? 'var(--green)' : 'var(--text)';
      const rsiZone  = r.rsi >= 70 ? 'ê³¼ë§¤ìˆ˜' : r.rsi <= 30 ? 'ê³¼ë§¤ë„' : r.rsi >= 50 ? 'ê°•ì„¸' : 'ì•½ì„¸';

      let divBadge = '';
      if (r.hasBearish) divBadge += '<span class="rsi-div-badge bear">ğŸ”» Bear</span>';
      if (r.hasBullish) divBadge += '<span class="rsi-div-badge bull">ğŸ”º Bull</span>';
      if (!r.hasBearish && !r.hasBullish) divBadge = '<span class="rsi-div-badge neutral">â€”</span>';

      // ë¯¸ë‹ˆ RSI SVG ì°¨íŠ¸
      let miniChart = '';
      if (r.rsiHistory && r.rsiHistory.length > 5) {
        const vals = r.rsiHistory;
        const len = vals.length;
        const w = 100, h = 40;
        const points = vals.map((v, i) => {
          const x = (i / (len - 1)) * w;
          const y = h - ((v / 100) * h);
          return `${x.toFixed(1)},${y.toFixed(1)}`;
        }).join(' ');
        // 70/30 ë¼ì¸ yì¢Œí‘œ
        const y70 = h - (70 / 100 * h), y30 = h - (30 / 100 * h);
        // ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ ì˜ì—­ + RSI ë¼ì¸
        miniChart = `<svg viewBox="0 0 ${w} ${h}" class="rsi-mini-svg" preserveAspectRatio="none">
          <rect x="0" y="0" width="${w}" height="${y70.toFixed(1)}" fill="rgba(231,76,90,.06)"/>
          <rect x="0" y="${y30.toFixed(1)}" width="${w}" height="${(h-y30).toFixed(1)}" fill="rgba(45,184,126,.06)"/>
          <line x1="0" y1="${y70.toFixed(1)}" x2="${w}" y2="${y70.toFixed(1)}" stroke="rgba(231,76,90,.25)" stroke-width=".5" stroke-dasharray="2,2"/>
          <line x1="0" y1="${y30.toFixed(1)}" x2="${w}" y2="${y30.toFixed(1)}" stroke="rgba(45,184,126,.25)" stroke-width=".5" stroke-dasharray="2,2"/>
          <polyline points="${points}" fill="none" stroke="#a78bfa" stroke-width="1.5" stroke-linejoin="round"/>
        </svg>`;
      }

      html += `
      <div class="rsi-tf-card">
        <div class="rsi-tf-label">${r.label}</div>
        ${miniChart}
        <div class="rsi-tf-val" style="color:${rsiColor}">${rsiVal}</div>
        <div class="rsi-tf-zone" style="color:${rsiColor}">${rsiZone}</div>
        <div class="rsi-tf-divs">${divBadge}</div>
      </div>`;
    });
    html += '</div>';

    // RSI ë‹¤ì´ë²„ì „ìŠ¤ ìƒì„¸ ë¡œê·¸
    const allDivs = [];
    tfOrder.forEach(tf => {
      const r = rsiResults[tf];
      if (!r) return;
      r.divergences.forEach(d => allDivs.push({ ...d, tf: r.label }));
    });
    if (allDivs.length) {
      html += '<div class="rsi-div-list">';
      allDivs.forEach(d => {
        const icon = d.type === 'bearish' ? 'ğŸ”»' : 'ğŸ”º';
        const color = d.type === 'bearish' ? 'var(--red)' : 'var(--green)';
        const label = d.type === 'bearish' ? 'BEAR DIV' : 'BULL DIV';
        html += `<div class="rsi-div-row" style="border-left:3px solid ${color}">
          <span style="color:${color};font-weight:900;font-size:11px">${icon} ${label}</span>
          <span style="color:var(--dim);font-size:10px">${d.tf}</span>
          <span style="font-size:10px">ê°€ê²© $${fmt(d.priceA)}â†’$${fmt(d.priceB)}</span>
          <span style="font-size:10px;color:var(--dim)">RSI ${d.rsiA.toFixed(1)}â†’${d.rsiB.toFixed(1)}</span>
        </div>`;
      });
      html += '</div>';
    }
    html += '<div style="font-size:10px;color:var(--dim);margin-top:6px;line-height:1.4">' +
      'ìƒìŠ¹(Bull): ê°€ê²©â†“ + RSIâ†‘ â†’ ë°˜ë“± ê°€ëŠ¥ Â· í•˜ë½(Bear): ê°€ê²©â†‘ + RSIâ†“ â†’ í•˜ë½ ê°€ëŠ¥<br>' +
      'ì—¬ëŸ¬ íƒ€ì„í”„ë ˆì„ ë™ì‹œ ê°ì§€ ì‹œ ì‹ ë¢°ë„ ì¦ê°€</div>';
    html += '</div>';

    // â•â•â• Fear & Greed â•â•â•
    html += '<div class="ss-section"><div class="ss-section-title">ğŸ˜± Fear & Greed Index</div>';
    if (fngData.length) {
      html += `<div class="ss-fng-row"><div class="ss-fng-gauge">${fngGauge(fngData[0].value)}</div>
        <div class="ss-fng-detail"><div class="ss-fng-label">${fngData[0].label}</div><div class="ss-fng-hist">`;
      fngData.slice(0,7).forEach(d => {
        const c = d.value<=25?'var(--red)':d.value<=45?'#f97316':d.value<=55?'#eab308':d.value<=75?'#84cc16':'var(--green)';
        html += `<div class="ss-fng-day"><span style="color:${c};font-weight:800">${d.value}</span><span class="ss-fng-dt">${d.time.getUTCMonth()+1}/${d.time.getUTCDate()}</span></div>`;
      });
      html += '</div></div></div>';
    } else html += '<div style="color:var(--dim);font-size:11px;padding:8px">ë¡œë“œ ì‹¤íŒ¨</div>';
    html += '</div>';

    // â•â•â• OI â•â•â•
    html += '<div class="ss-section"><div class="ss-section-title">ğŸ“Š ë¯¸ê²°ì œì•½ì • (OI)</div>';
    if (oiCurrent) {
      let change24 = null, change4h = null;
      if (oiData.length >= 24) { const a = oiData[Math.max(0,oiData.length-24)].oiValue, n = oiData[oiData.length-1].oiValue; change24 = ((n-a)/a)*100; }
      if (oiData.length >= 4)  { const a = oiData[Math.max(0,oiData.length-4)].oiValue,  n = oiData[oiData.length-1].oiValue; change4h  = ((n-a)/a)*100; }
      const chgC = v => !v ? 'var(--dim)' : v >= 0 ? 'var(--green)' : 'var(--red)';
      const chgF = v => !v ? '-' : (v>=0?'+':'')+v.toFixed(2)+'%';
      html += `<div class="ss-oi-stats">
        <div class="ss-oi-stat"><div class="ss-oi-label">í˜„ì¬ OI</div><div class="ss-oi-val">${oiCurrent.oi.toLocaleString('en-US',{maximumFractionDigits:0})} BTC</div></div>
        <div class="ss-oi-stat"><div class="ss-oi-label">4h ë³€í™”</div><div class="ss-oi-val" style="color:${chgC(change4h)}">${chgF(change4h)}</div></div>
        <div class="ss-oi-stat"><div class="ss-oi-label">24h ë³€í™”</div><div class="ss-oi-val" style="color:${chgC(change24)}">${chgF(change24)}</div></div>
      </div><div class="ss-oi-chart-wrap"><div style="font-size:10px;color:var(--dim);margin-bottom:4px">OI 48ì‹œê°„ ì¶”ì´</div>${oiChart()}</div>`;
    }
    html += '</div>';

    // â•â•â• í€ë”©ë¹„ â•â•â•
    html += '<div class="ss-section"><div class="ss-section-title">ğŸ’° í€ë”©ë¹„ í˜„í™© (Bybit)</div>';
    if (fundCurrent) {
      const rc = fundCurrent.rate >= 0 ? 'var(--green)' : 'var(--red)';
      const ac = fundCurrent.avg3 >= 0 ? 'var(--green)' : 'var(--red)';
      html += `<div class="ss-fund-row">
        <div class="ss-fund-stat"><div class="ss-oi-label">í˜„ì¬</div><div class="ss-oi-val" style="color:${rc}">${fmtP(fundCurrent.rate)}</div></div>
        <div class="ss-fund-stat"><div class="ss-oi-label">3íšŒ í‰ê· </div><div class="ss-oi-val" style="color:${ac}">${fmtP(fundCurrent.avg3)}</div></div>
        <div class="ss-fund-stat"><div class="ss-oi-label">ì•Œë¦¼ ê¸°ì¤€</div><div class="ss-oi-val" style="color:var(--amber)">Â±0.03%</div></div>
      </div>`;
    }
    html += '</div>';

    // â•â•â• ì²´í¬ë¦¬ìŠ¤íŠ¸ â•â•â•
    const bearCount = Object.values(rsiResults).filter(r => r.hasBearish).length;
    html += `<div class="ss-section"><div class="ss-section-title">ğŸ“‹ ìˆ ì§„ì… ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
    <div class="ss-checklist">
      <div class="ss-check-item ${fngData.length && fngData[0].value >= 70 ? 'active' : ''}">${fngData.length && fngData[0].value >= 70 ? 'âœ…' : 'â¬œ'} Fear & Greed â‰¥ 70</div>
      <div class="ss-check-item ${fundCurrent && fundCurrent.rate > 0.0003 ? 'active' : ''}">${fundCurrent && fundCurrent.rate > 0.0003 ? 'âœ…' : 'â¬œ'} í€ë”©ë¹„ > +0.03%</div>
      <div class="ss-check-item ${oiData.length >= 24 && ((oiData[oiData.length-1].oiValue-oiData[Math.max(0,oiData.length-24)].oiValue)/oiData[Math.max(0,oiData.length-24)].oiValue*100) > 5 ? 'active' : ''}">
        ${oiData.length >= 24 && ((oiData[oiData.length-1].oiValue-oiData[Math.max(0,oiData.length-24)].oiValue)/oiData[Math.max(0,oiData.length-24)].oiValue*100) > 5 ? 'âœ…' : 'â¬œ'} OI 24h > +5%</div>
      <div class="ss-check-item ${bearCount >= 2 ? 'active' : ''}">${bearCount >= 2 ? 'âœ…' : 'â¬œ'} RSI í•˜ë½ ë‹¤ì´ë²„ì „ìŠ¤ 2+ê°œ TF</div>
      <div class="ss-check-item">â¬œ ê°€ê²©ì´ L1 Ext/L2 ì €í•­ëŒ€ ê·¼ì ‘</div>
    </div>
    <div style="font-size:10px;color:var(--dim);margin-top:6px">â€» 3ê°œ ì´ìƒ ì¶©ì¡± ì‹œ ìˆ ì§„ì… ì ê·¹ ê³ ë ¤</div></div>`;

    el.innerHTML = html;
  }

  async function load() {
    if (loaded) return;
    const status = $('ss-status');
    if (status) status.textContent = 'ë°ì´í„° ë¡œë”© ì¤‘â€¦';
    await Promise.allSettled([loadFNG(), loadOI(), loadFunding(), loadRSI()]);
    if (status) status.textContent = '';
    render();
    loaded = true;
  }

  async function refresh() {
    loaded = false;
    fngData = []; oiData = []; oiCurrent = null; fundCurrent = null; rsiResults = {};
    await load();
  }

  return { load, refresh };
})();


/* ---- backtest.js ---- */
// ============================================================
// BACKTEST.JS â€” S/R Zone ë°±í…ŒìŠ¤íŠ¸ (L1 + L1 Ext + L2)
// ê¸°ê°„ ì„ íƒ: 2ì£¼ / 1ê°œì›” (15ë¶„ë´‰ í˜ì´ì§€ë„¤ì´ì…˜)
// ============================================================
const Backtest = (() => {

  let running = false;
  const $ = id => document.getElementById(id);
  const fmt = n => typeof n === 'number' ? n.toFixed(1) : n;

  let period = '1m'; // '2w' or '1m'

  function setPeriod(p, btn) {
    period = p;
    document.querySelectorAll('.bt-period-btn').forEach(b => b.classList.remove('on'));
    if (btn) btn.classList.add('on');
  }

  // 15ë¶„ë´‰ í˜ì´ì§€ë„¤ì´ì…˜ (1500ê°œ ë‹¨ìœ„, endTime ê¸°ë°˜)
  async function fetch15m(totalCandles) {
    const batchSize = 1500;
    let all = [];
    let endTime = null;

    while (all.length < totalCandles) {
      const remain = totalCandles - all.length;
      const limit = Math.min(remain, batchSize);
      const params = { symbol: Config.SYM, interval: '15m', limit };
      if (endTime) params.endTime = endTime;

      const raw = await API.call('klines', params);
      if (!raw.length) break;

      const batch = raw.map(k => ({
        time: k[0] / 1000, open: +k[1], high: +k[2], low: +k[3], close: +k[4]
      }));

      // endTime ì´ì „ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ì²« ë´‰ì˜ ì‹œì‘ì‹œê°„ - 1 ì‚¬ìš©
      endTime = raw[0][0] - 1;

      // ì—­ìˆœìœ¼ë¡œ ìŒ“ì„ â†’ ì•ì— ë¶™ì´ê¸°
      all = batch.concat(all);

      const statusEl = $('bt-status');
      if (statusEl) statusEl.textContent = `15ë¶„ë´‰ ë¡œë”© ì¤‘â€¦ ${all.length.toLocaleString()}ê°œ`;

      // ê³¼ë„í•œ í˜¸ì¶œ ë°©ì§€ ë”œë ˆì´
      if (all.length < totalCandles && raw.length === limit) {
        await new Promise(r => setTimeout(r, 300));
      } else break;
    }

    return all;
  }

  async function run() {
    if (running) return;
    running = true;
    const statusEl = $('bt-status'), resultEl = $('bt-results');
    if (statusEl) statusEl.textContent = 'ë°ì´í„° ë¡œë”© ì¤‘â€¦';
    if (resultEl) resultEl.innerHTML = '';

    try {
      // ê¸°ê°„ì— ë”°ë¥¸ ìº”ë“¤ ìˆ˜ ê³„ì‚° (15ë¶„ë´‰)
      // 2ì£¼ = 14ì¼ Ã— 24h Ã— 4 = 1,344 â†’ 1,500 1íšŒ
      // 1ê°œì›” = 30ì¼ Ã— 24h Ã— 4 = 2,880 â†’ 1,500 Ã— 2íšŒ
      const candleCount = period === '2w' ? 1500 : 2900;

      const k15m = await fetch15m(candleCount);

      if (statusEl) statusEl.textContent = 'ì¼ë´‰ ë¡œë”©â€¦';
      const rawD = await API.klines(Config.SYM, '1d', 120);
      const daily = API.parseDailyKlines(rawD);
      SR._calcTR(daily);

      if (k15m.length < Config.HMA_PERIOD + 50) throw new Error(`15m ë°ì´í„° ë¶€ì¡± (${k15m.length}ê°œ)`);

      if (statusEl) statusEl.textContent = `ì—°ì‚° ì¤‘â€¦ (${k15m.length.toLocaleString()}ê°œ ìº”ë“¤)`;

      const hmaAll = HMA.fromCandles(k15m, Config.HMA_PERIOD);
      const hmaOffset = k15m.length - hmaAll.length;
      const atrArr = [];
      for (let i = 0; i < daily.length; i++) atrArr.push(SR._calcATR(daily, i, Config.ATR_P));

      const { FI, FO, L1E_F1, L1E_F2, L2_F1, L2_F2 } = Config;
      const zoneConfigs = [
        { name: 'resL1',    factor: [FI, FO],         dir:  1, label: 'ì €í•­ L1 (0.382~0.500)' },
        { name: 'supL1',    factor: [FI, FO],         dir: -1, label: 'ì§€ì§€ L1 (0.382~0.500)' },
        { name: 'resL1ext', factor: [L1E_F1, L1E_F2], dir:  1, label: 'ì €í•­ L1 Ext (0.618~0.786)' },
        { name: 'supL1ext', factor: [L1E_F1, L1E_F2], dir: -1, label: 'ì§€ì§€ L1 Ext (0.618~0.786)' },
        { name: 'resL2',    factor: [L2_F1, L2_F2],   dir:  1, label: 'ì €í•­ L2 (1.000~1.272)' },
        { name: 'supL2',    factor: [L2_F1, L2_F2],   dir: -1, label: 'ì§€ì§€ L2 (1.000~1.272)' },
      ];

      const stats = {};
      zoneConfigs.forEach(z => {
        stats[z.name] = { touches: 0, rejections: 0, breakouts: 0, reversalSum: 0, label: z.label };
      });

      const LOOK_FWD = 8, EVAL_GAP = 16;

      for (let i = hmaOffset + 10; i < k15m.length - LOOK_FWD; i += EVAL_GAP) {
        const hIdx = i - hmaOffset;
        if (hIdx < 0 || hIdx >= hmaAll.length) continue;
        const center = hmaAll[hIdx].value;
        const candleTime = k15m[i].time;
        const dayIdx = daily.findIndex(d => d.openTime / 1000 > candleTime) - 1;
        if (dayIdx < 0 || !atrArr[dayIdx]) continue;
        const atr = atrArr[dayIdx];

        zoneConfigs.forEach(zc => {
          const stat = stats[zc.name];
          const zTop = center + zc.factor[1] * atr * zc.dir;
          const zBot = center + zc.factor[0] * atr * zc.dir;
          const top = Math.max(zTop, zBot), bot = Math.min(zTop, zBot);

          let touchIdx = -1;
          for (let j = i; j < Math.min(i + LOOK_FWD, k15m.length); j++) {
            if (k15m[j].high >= bot && k15m[j].low <= top) { touchIdx = j; break; }
          }
          if (touchIdx < 0) return;
          stat.touches++;

          const post = k15m.slice(touchIdx + 1, touchIdx + 1 + LOOK_FWD);
          if (!post.length) return;

          if (zc.dir > 0) {
            if (post.some(c => c.close > top)) stat.breakouts++;
            else { stat.rejections++; stat.reversalSum += k15m[touchIdx].high - Math.min(...post.map(c => c.low)); }
          } else {
            if (post.some(c => c.close < bot)) stat.breakouts++;
            else { stat.rejections++; stat.reversalSum += Math.max(...post.map(c => c.high)) - k15m[touchIdx].low; }
          }
        });
      }

      if (statusEl) statusEl.textContent = 'âœ… ì™„ë£Œ!';
      renderResults(stats, k15m);
    } catch (e) {
      if (statusEl) statusEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
    }
    running = false;
  }

  function renderResults(stats, k15m) {
    const el = $('bt-results');
    if (!el) return;
    const periodStart = new Date(k15m[0].time * 1000).toLocaleDateString('ko-KR');
    const periodEnd   = new Date(k15m[k15m.length - 1].time * 1000).toLocaleDateString('ko-KR');
    const days = Math.round((k15m[k15m.length-1].time - k15m[0].time) / 86400);

    let html = `<div class="bt-meta"><span>ê¸°ê°„: ${periodStart} ~ ${periodEnd} (${days}ì¼)</span><span>ìº”ë“¤: ${k15m.length.toLocaleString()}ê°œ</span></div>`;
    html += `<table class="bt-table"><thead><tr><th></th><th>Zone</th><th>í„°ì¹˜</th><th>ë°˜ì „</th><th>ëŒíŒŒ</th><th>ë°˜ì „ìœ¨</th><th>Avgë°˜ì „</th></tr></thead><tbody>`;

    const groups = [
      { label: 'Level 1 (0.382 ~ 0.500)',     keys: ['resL1','supL1'] },
      { label: 'Level 1 Ext (0.618 ~ 0.786)',  keys: ['resL1ext','supL1ext'] },
      { label: 'Level 2 (1.000 ~ 1.272)',      keys: ['resL2','supL2'] },
    ];

    groups.forEach(g => {
      html += `<tr class="bt-section"><td colspan="7">${g.label}</td></tr>`;
      g.keys.forEach(name => {
        const s = stats[name], total = s.touches;
        const rejRate = total > 0 ? (s.rejections / total * 100) : 0;
        const avgRev = s.rejections > 0 ? '$' + (s.reversalSum / s.rejections).toFixed(0) : '-';
        const cls = rejRate >= 60 ? 'good' : rejRate >= 40 ? 'mid' : 'weak';
        html += `<tr class="bt-row ${cls}"><td>${total >= 3 ? 'âœ“' : 'âœ—'}</td>
          <td>${s.label}</td><td>${total}</td><td>${s.rejections}</td><td>${s.breakouts}</td>
          <td class="bt-rate">${total > 0 ? fmt(rejRate)+'%' : '-'}</td><td>${avgRev}</td></tr>`;
      });
    });

    html += `</tbody></table>
      <div class="bt-legend"><span class="bt-good">â—</span> 60%â†‘ &nbsp;<span class="bt-mid">â—</span> 40~60% &nbsp;<span class="bt-weak">â—</span> 40%â†“</div>`;
    el.innerHTML = html;
  }

  return { run, setPeriod };
})();


/* ---- app.js ---- */
// ============================================================
// APP.JS â€” ë©”ì¸ ì§„ì…ì 
// ============================================================
const App = (() => {

  const fmt = n => Math.round(n).toLocaleString('en-US');
  const $   = id => document.getElementById(id);

  function toast(title, body) {
    const d = document.createElement('div');
    d.className = 'toast';
    d.innerHTML = `<b>${title}</b><span>${body}</span>`;
    $('toasts').appendChild(d);
    setTimeout(() => d.remove(), 5000);
  }

  function tick() {
    const kst = new Date(Date.now() + 9 * 3600000);
    const d = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    $('clk').textContent =
      `${kst.getUTCFullYear()}.${String(kst.getUTCMonth()+1).padStart(2,'0')}.${String(kst.getUTCDate()).padStart(2,'0')} (${d[kst.getUTCDay()]}) ${String(kst.getUTCHours()).padStart(2,'0')}:${String(kst.getUTCMinutes()).padStart(2,'0')}:${String(kst.getUTCSeconds()).padStart(2,'0')} KST`;
  }

  async function livePrice() {
    try {
      const p = await API.tickerPrice(Config.SYM);
      $('lprice').textContent = '$' + fmt(p);
    } catch {}
  }

  async function loadSR() {
    try {
      const data = await SR.compute();
      const { levels, prev, hist } = data;
      $('R2').textContent = fmt(levels.r2);  $('R1').textContent = fmt(levels.r1);
      $('S1').textContent = fmt(levels.s1);  $('S2').textContent = fmt(levels.s2);
      $('R4').textContent = fmt(levels.r4);  $('R3').textContent = fmt(levels.r3);
      $('S3').textContent = fmt(levels.s3);  $('S4').textContent = fmt(levels.s4);
      $('R6').textContent = fmt(levels.r6);  $('R5').textContent = fmt(levels.r5);
      $('S5').textContent = fmt(levels.s5);  $('S6').textContent = fmt(levels.s6);
      $('mCenter').textContent = '$' + fmt(levels.center);
      $('mO').textContent = fmt(prev.open);  $('mH').textContent = fmt(prev.high);
      $('mL').textContent = fmt(prev.low);   $('mC').textContent = fmt(prev.close);
      $('mA').textContent = fmt(prev.atr);
      $('mD').textContent = `${prev.date.getUTCMonth()+1}/${prev.date.getUTCDate()}`;
      $('loadToday').style.display = 'none';
      $('today').style.display     = 'block';
      ChartModule.setSRLevels(levels);
      History.setData(hist);
      History.render();
    } catch(e) {
      $('loadToday').style.display = 'none';
      $('errToday').style.display  = 'block';
      $('errToday').textContent    = 'âš ï¸ ' + e.message;
      $('histLoad').style.display  = 'none';
    }
  }

  let curTab = 0;
  let fundLoaded = false, hmLoaded = false, ssLoaded = false, sigLoaded = false;
  function go(i) {
    curTab = i;
    document.querySelectorAll('.tab').forEach((t, j) => t.classList.toggle('on', j === i));
    document.querySelectorAll('.pane').forEach((p, j) => p.classList.toggle('on', j === i));
    if (i === 1) ChartModule.load();
    if (i === 5 && !fundLoaded) { fundLoaded = true; Funding.init(); }
    if (i === 6 && !sigLoaded)  { sigLoaded = true; Signal.init(); }
    if (i === 7 && !ssLoaded)   { ssLoaded = true; ShortSignal.load(); }
    if (i === 9 && !hmLoaded)   { hmLoaded = true; Heatmap.load(); }
  }

  function toggleL1()  { const v = ChartModule.getVisibility(); ChartModule.setShowL1(!v.l1);   $('btnL1').classList.toggle('on', !v.l1); }
  function toggleL1E() { const v = ChartModule.getVisibility(); ChartModule.setShowL1E(!v.l1e); $('btnL1E').classList.toggle('on', !v.l1e); }
  function toggleL2()  { const v = ChartModule.getVisibility(); ChartModule.setShowL2(!v.l2);   $('btnL2').classList.toggle('on', !v.l2); }

  async function loadHistSR() {
    const dateVal = $('srDateInput').value;
    if (!dateVal) { toast('âš ï¸', 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
    const status = $('histSrStatus');
    status.textContent = 'ê³„ì‚° ì¤‘â€¦';
    try {
      const targetTime = new Date(dateVal + 'T23:59:59Z').getTime();
      const result = await SR.computeHistorical(targetTime);
      ChartModule.setSRLevels(result.levels, dateVal);
      ChartModule.loadHistorical(result.candles15m);
      ChartModule.setShowL1(true); $('btnL1').classList.add('on');
      $('R2').textContent = fmt(result.levels.r2); $('R1').textContent = fmt(result.levels.r1);
      $('S1').textContent = fmt(result.levels.s1); $('S2').textContent = fmt(result.levels.s2);
      $('R4').textContent = fmt(result.levels.r4); $('R3').textContent = fmt(result.levels.r3);
      $('S3').textContent = fmt(result.levels.s3); $('S4').textContent = fmt(result.levels.s4);
      $('R6').textContent = fmt(result.levels.r6); $('R5').textContent = fmt(result.levels.r5);
      $('S5').textContent = fmt(result.levels.s5); $('S6').textContent = fmt(result.levels.s6);
      $('mCenter').textContent = '$' + fmt(result.levels.center);
      status.textContent = dateVal + ' ê¸°ì¤€ S/R ë¡œë“œ ì™„ë£Œ';
      go(1);
    } catch (e) { status.textContent = 'ì˜¤ë¥˜: ' + e.message; }
  }

  async function resetToLive() {
    $('histSrStatus').textContent = '';
    await loadSR();
    ChartModule.load();
    toast('ğŸ”„', 'ì‹¤ì‹œê°„ ëª¨ë“œë¡œ ë³µê·€');
  }

  function openSettings() { $('apiKeyInput').value = Config.getApiKey(); $('settingsModal').classList.add('open'); }
  function closeSettings() { $('settingsModal').classList.remove('open'); }
  function saveSettings() {
    const key = $('apiKeyInput').value.trim();
    Config.setApiKey(key); closeSettings();
    toast('âœ… ì„¤ì • ì €ì¥ë¨', key ? 'API Key ë“±ë¡ë¨' : 'API Key ì œê±°ë¨');
  }

  function openBinanceChart() { window.open('https://www.binance.com/futures/BTCUSDT', '_blank'); }

  function bindTFButtons() {
    document.querySelectorAll('.tf').forEach(b => {
      b.onclick = () => {
        document.querySelectorAll('.tf').forEach(x => x.classList.remove('on'));
        b.classList.add('on');
        ChartModule.load(b.dataset.tf);
      };
    });
  }

  async function init() {
    tick(); setInterval(tick, 1000);
    livePrice(); setInterval(livePrice, 5000);
    bindTFButtons();
    Crash.init();
    await loadSR();
    Volume.load();
  }

  window.addEventListener('DOMContentLoaded', init);

  return {
    toast, go, toggleL1, toggleL1E, toggleL2,
    loadHistSR, resetToLive,
    openSettings, closeSettings, saveSettings,
    openBinanceChart
  };
})();

</script>
</body>
</html>
